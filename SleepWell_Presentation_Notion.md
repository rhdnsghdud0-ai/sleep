# ğŸŒ™ SleepWell Backend í”„ë¡œì íŠ¸ ë°œí‘œ
## AI ê¸°ë°˜ ìˆ˜ë©´ ê±´ê°• ê´€ë¦¬ í”Œë«í¼

---


# ğŸ“‘ ëª©ì°¨

1. [í”„ë¡œì íŠ¸ ì†Œê°œ](#1-í”„ë¡œì íŠ¸-ì†Œê°œ)
2. [í•µì‹¬ ê¸°ìˆ  ìŠ¤íƒ](#2-í•µì‹¬-ê¸°ìˆ -ìŠ¤íƒ)
3. [ì£¼ìš” ê¸°ëŠ¥ ë°ëª¨](#3-ì£¼ìš”-ê¸°ëŠ¥-ë°ëª¨)
4. [ì•„í‚¤í…ì²˜ ë° ì„¤ê³„](#4-ì•„í‚¤í…ì²˜-ë°-ì„¤ê³„)
5. [ì„±ê³¼ ë° í•™ìŠµ](#5-ì„±ê³¼-ë°-í•™ìŠµ)
6. [í–¥í›„ ê³„íš](#6-í–¥í›„-ê³„íš)

---

# 1. í”„ë¡œì íŠ¸ ì†Œê°œ

##  What is SleepWell?

> **AI ê¸°ë°˜ ìˆ˜ë©´ ê±´ê°• ê´€ë¦¬ í”Œë«í¼ì˜ ë°±ì—”ë“œ ì‹œìŠ¤í…œ**

### í”„ë¡œì íŠ¸ ê·œëª¨ & ê°œë°œ í˜„í™©

####  ê°œë°œ ì§„í–‰ë¥  í˜„í™©

**ë°±ì—”ë“œ ê°œë°œ ì™„ì„±ë„: 95%**

**ğŸ“ˆ ê°œë°œ ì§„í–‰ë¥  í˜„í™©**

| ìƒíƒœ | ì‹œìŠ¤í…œ | ì™„ì„±ë„ |
|------|--------|--------|
| âœ… **ì™„ë£Œ** | AI ìƒë‹´ ì‹œìŠ¤í…œ | 100% |
| âœ… **ì™„ë£Œ** | ìˆ˜ë©´ í’ˆì§ˆ ë¶„ì„ | 100% |
| âœ… **ì™„ë£Œ** | ë°ì´í„° í†µí•© ì‹œìŠ¤í…œ | 100% |
| âœ… **ì™„ë£Œ** | ì‚¬ìš©ì ì¸ì¦/ë³´ì•ˆ | 100% |
| âœ… **ì™„ë£Œ** | ê²°ì œ ì‹œìŠ¤í…œ | 100% |
| âœ… **ì™„ë£Œ** | ìŒì„± ì²˜ë¦¬ STT/TTS | 100% |
| âœ… **ì™„ë£Œ** | ì•Œë¦¼ í…œí”Œë¦¿ ì‹œìŠ¤í…œ | 100% |
| âœ… **ì™„ë£Œ** | ASMR ìŠ¤íŠ¸ë¦¬ë° | 100% |
| ğŸ”„ **ì§„í–‰ì¤‘** | Admin ì›¹ UI | 80% |
| ğŸ”„ **ì§„í–‰ì¤‘** | ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ | 70% |
| ğŸ“‹ **ì˜ˆì •** | AWS S3 ì‹¤ì œ ì—°ë™ | 40% |

```mermaid
pie title ì „ì²´ ì‹œìŠ¤í…œ ì™„ì„±ë„
    "ì™„ë£Œ (8ê°œ)" : 80
    "ì§„í–‰ì¤‘ (2ê°œ)" : 15
    "ì˜ˆì • (1ê°œ)" : 5
```

####  í”„ë¡œì íŠ¸ í†µê³„
- **ê°œë°œ ê¸°ê°„**: 2025.05 ~ 2025.09 (4ê°œì›”)
- **ì»¤ë°‹ ìˆ˜**: 191ê°œ
- **ì½”ë“œ ë¼ì¸**: 45,000+ ë¼ì¸
- **ì‹œìŠ¤í…œ êµ¬ì„±**: **11ê°œ í•µì‹¬ ì‹œìŠ¤í…œ** í†µí•© í”Œë«í¼
- **API ì—”ë“œí¬ì¸íŠ¸**: **17ê°œ ì»¨íŠ¸ë¡¤ëŸ¬, 25ê°œ ì„œë¹„ìŠ¤**

### í•µì‹¬ íŠ¹ì§•
- **11ê°œ ì£¼ìš” ì‹œìŠ¤í…œ** í†µí•© í”Œë«í¼
- **í†µê³„ ê¸°ë°˜ ê°œì¸í™”** íŒ¨í„´ ê¸°ë°˜ ë¡œì§ìœ¼ë¡œ í•™ìŠµí•˜ëŠ” ìˆ˜ë©´ ì•Œë¦¼
- **ì™„ì „í•œ ìŒì„± AI** STT/TTS ì–‘ë°©í–¥ ì²˜ë¦¬
- **ìˆ˜ë©´ í’ˆì§ˆ ë¶„ì„** ì—°êµ¬ ê¸°ë°˜ ê°€ì¤‘ì¹˜ ì•Œê³ ë¦¬ì¦˜
- **í™•ì¥ ê°€ëŠ¥í•œ ì•„í‚¤í…ì²˜** ëŒ€ìš©ëŸ‰ ì²˜ë¦¬ ê°€ëŠ¥í•œ ì„¤ê³„

### ğŸ”„ ìœ ì € í”Œë¡œìš° ë‹¤ì´ì–´ê·¸ë¨

```mermaid
flowchart TD
    A[ì‚¬ìš©ì ì•± ì‹¤í–‰] --> B{ì²˜ìŒ ì‚¬ìš©ì?}

    B -->|ì˜ˆ| C[íšŒì›ê°€ì…]
    B -->|ì•„ë‹ˆì˜¤| D[ë¡œê·¸ì¸]

    C --> E[ê¸°ë³¸ ì •ë³´ ì…ë ¥<br/>ë‚˜ì´, ì„±ë³„, ìˆ˜ë©´ ëª©í‘œ]
    D --> F[ë©”ì¸ ëŒ€ì‹œë³´ë“œ]
    E --> F

    F --> G[ìˆ˜ë©´ ê¸°ë¡ ë“±ë¡]
    F --> H[AI ìƒë‹´ ì‹œì‘]
    F --> I[ASMR ì¬ìƒ]
    F --> J[ìˆ˜ë©´ ë¶„ì„ í™•ì¸]

    G --> K[í”Œë«í¼ ì„ íƒ<br/>Samsung/Apple/Google]
    K --> L[ë°ì´í„° ë™ê¸°í™”]
    L --> M[ìˆ˜ë©´ í’ˆì§ˆ ì ìˆ˜ ê³„ì‚°]
    M --> N[ê°œì¸í™” ì•Œë¦¼ ì„¤ì •]

    H --> O[ìƒë‹´ ì£¼ì œ ì„ íƒ]
    O --> P[AIì™€ ëŒ€í™”]
    P --> Q[ë§ì¶¤í˜• ì¡°ì–¸ ìˆ˜ì‹ ]

    I --> R[ì¹´í…Œê³ ë¦¬ ì„ íƒ<br/>ìì—°ìŒ/ë°±ìƒ‰ì†ŒìŒ/ëª…ìƒ]
    R --> S[ASMR ìŠ¤íŠ¸ë¦¬ë° ì¬ìƒ]
    S --> T[ìˆ˜ë©´ íƒ€ì´ë¨¸ ì„¤ì •]

    J --> U[ì¼ì¼ ë¶„ì„ ë³´ê³ ì„œ]
    U --> V[ì£¼ê°„/ì›”ê°„ íŠ¸ë Œë“œ]
    V --> W[ê°œì„  ì œì•ˆì‚¬í•­]

    N --> X[ìŠ¤ë§ˆíŠ¸ ì•Œë¦¼ ìˆ˜ì‹ ]
    Q --> Y[ìƒë‹´ ë‚´ì—­ ì €ì¥]
    T --> Z[ìë™ í˜ì´ë“œì•„ì›ƒ]
    W --> AA[ìˆ˜ë©´ ëª©í‘œ ì¡°ì •]

    style A fill:#4fc3f7,stroke:#01579b,stroke-width:2px,color:#000
    style F fill:#ba68c8,stroke:#4a148c,stroke-width:2px,color:#fff
    style M fill:#81c784,stroke:#1b5e20,stroke-width:2px,color:#000
    style P fill:#ffb74d,stroke:#e65100,stroke-width:2px,color:#000
    style S fill:#f48fb1,stroke:#880e4f,stroke-width:2px,color:#000
```

###  ì‚¬ìš©ì ì—¬ì • ë§µ

```mermaid
flowchart LR
    subgraph A["ğŸš€ ì˜¨ë³´ë”© ë‹¨ê³„ (1-2ì¼)"]
        A1[ğŸ” íšŒì›ê°€ì…]
        A2[âš™ï¸ ê°œì¸ì„¤ì •]
        A3[ğŸ”— ë””ë°”ì´ìŠ¤ì—°ë™]
        A4[ğŸ“± ì•Œë¦¼ê¶Œí•œì„¤ì •]
        A1 --> A2 --> A3 --> A4
    end

    subgraph B["ğŸ“± ì¼ìƒ ì‚¬ìš© (ë§¤ì¼ 5-10ë¶„)"]
        B1[ğŸ“Š ìˆ˜ë©´ê¸°ë¡]
        B2[ğŸ¤– AIìƒë‹´]
        B3[ğŸµ ASMRì¬ìƒ]
        B4[ğŸ’¡ ìŠ¤ë§ˆíŠ¸ì•Œë¦¼]
        B1 --> B2 --> B3 --> B4
    end

    subgraph C["ğŸ“ˆ ë¶„ì„ ê°œì„  (ì£¼ 1íšŒ)"]
        C1[ğŸ“ˆ íŠ¸ë Œë“œë¶„ì„]
        C2[ğŸ¯ ëª©í‘œì¬ì„¤ì •]
        C3[ğŸ“± ì•Œë¦¼ìµœì í™”]
        C4[ğŸ”„ íŒ¨í„´ê°œì„ ]
        C1 --> C2 --> C3 --> C4
    end

    A --> B --> C
    C --> B
```

---

# 2. í•µì‹¬ ê¸°ìˆ  ìŠ¤íƒ

## Technology Stack

### Backend Framework
```java
Spring Boot 3.5.0
â”œâ”€â”€ Spring AI 1.0.0          // ì°¨ì„¸ëŒ€ AI í†µí•©
â”œâ”€â”€ Spring Security           // JWT + OAuth2
â”œâ”€â”€ Spring Data JPA          // ë°ì´í„° ì˜ì†ì„±
â””â”€â”€ Spring Actuator          // ëª¨ë‹ˆí„°ë§
```

### AI Integration
- **OpenAI GPT-4**: ëŒ€í™”í˜• ìƒë‹´
- **Anthropic Claude**: ë°ì´í„° ë¶„ì„
- **Spring AI**: ë©€í‹° ëª¨ë¸ í†µí•© í”„ë ˆì„ì›Œí¬

### Database & Cache
- **MySQL 8.0**: ë©”ì¸ ë°ì´í„°ë² ì´ìŠ¤
- **Redis**: ìºì‹± ë ˆì´ì–´
- **JPA/Hibernate**: ORM

### External Services
- **Firebase FCM**: í‘¸ì‹œ ì•Œë¦¼
- **AWS S3**: íŒŒì¼ ì €ì¥ì†Œ
- **í† ìŠ¤í˜ì´ë¨¼ì¸ **: ê²°ì œ ì‹œìŠ¤í…œ

---

# 3. ì£¼ìš” ê¸°ëŠ¥ ë°ëª¨

##  1. ì‚¬ìš©ì ì¸ì¦ ì‹œìŠ¤í…œ

### JWT + OAuth2 í†µí•© ì¸ì¦
```http
POST /api/auth/login
{
  "email": "user@sleepwell.com",
  "password": "password123"
}

Response:
{
  "token": "eyJhbGciOiJIUzUxMi...",
  "refreshToken": "eyJhbGciOiJIUzUxMi...",
  "expiresIn": 86400
}
```

**íŠ¹ì§•**:
- HS512 ì•”í˜¸í™” ì•Œê³ ë¦¬ì¦˜
- 64ë°”ì´íŠ¸ ì´ìƒ ë¹„ë°€í‚¤ ê°•ì œ
- Refresh Token ìë™ ê°±ì‹ 

---

##  2. ìˆ˜ë©´ ë°ì´í„° ê´€ë¦¬

### ë©€í‹° í”Œë«í¼ ë°ì´í„° í†µí•©
```http
POST /api/sleep/records/platform/samsung
{
  "sleepStartTime": "2025-01-18T23:00:00",
  "sleepEndTime": "2025-01-19T07:00:00",
  "totalSleepMinutes": 480,
  "deepSleepMinutes": 120,
  "lightSleepMinutes": 280,
  "remSleepMinutes": 80
}
```

**ì§€ì› í”Œë«í¼**:
- Samsung Health âœ…
- Apple Health âœ…
- Google Fit âœ…
- Flutter Health âœ…

---

## ìˆ˜ë©´ í’ˆì§ˆ ë¶„ì„ ì‹œìŠ¤í…œ 

###  "ìˆ˜ë©´ í’ˆì§ˆ ì ìˆ˜ëŠ” ì–´ë–»ê²Œ ì‚°ì •í•˜ëŠ”ê°€?"

####  ê³¼í•™ì  ì ìˆ˜ ê³„ì‚° ì•Œê³ ë¦¬ì¦˜
```java
// 1ï¸âƒ£ ì—°êµ¬ ê¸°ë°˜ ê°€ì¤‘ì¹˜ ì •ì˜ (Sleep Foundation ì—°êµ¬ ë°˜ì˜)
private static final double DEEP_SLEEP_WEIGHT = 0.25;      // ê¹Šì€ ìˆ˜ë©´ (ì‹ ì²´ íšŒë³µ)
private static final double REM_SLEEP_WEIGHT = 0.20;       // REM ìˆ˜ë©´ (ê¸°ì–µ í†µí•©)
private static final double SLEEP_EFFICIENCY_WEIGHT = 0.20; // ìˆ˜ë©´ íš¨ìœ¨ì„± (ë¶ˆë©´ì¦ ì§€í‘œ)
private static final double TOTAL_SLEEP_TIME_WEIGHT = 0.15; // ì´ ìˆ˜ë©´ ì‹œê°„ (ì—°ë ¹ ë³´ì •)
private static final double WASO_WEIGHT = 0.10;            // ìˆ˜ë©´ ì¤‘ ê°ì„± (ë‹¨í¸í™”)
private static final double SPO2_WEIGHT = 0.05;            // í˜ˆì¤‘ ì‚°ì†Œ (ë¬´í˜¸í¡ì¦)

// 2ï¸âƒ£ ê°œë³„ ì§€í‘œë³„ ì ìˆ˜ ê³„ì‚° ë¡œì§
private double calculateDeepSleepScore(SleepRecord record) {
    Double deepSleepRatio = record.calculateDeepSleepRatio();

    // ìµœì  ë²”ìœ„: 15-25%, 20%ê°€ ì´ìƒì  (ìˆ˜ë©´ì˜í•™ ì—°êµ¬ ê¸°ë°˜)
    if (deepSleepRatio >= 0.15 && deepSleepRatio <= 0.25) {
        double distanceFromOptimal = Math.abs(deepSleepRatio - 0.20);
        return Math.max(90, 100 - (distanceFromOptimal * 50));
    } else if (deepSleepRatio < 0.15) {
        return Math.max(30, deepSleepRatio * 400); // ë¶€ì¡± ì‹œ ê°ì 
    } else {
        return Math.max(60, 100 - (deepSleepRatio - 0.25) * 300); // ê³¼ë‹¤ ì‹œ ê°ì 
    }
}

// 3ï¸âƒ£ ê°œì¸í™” ì¡°ì • (ì—°ë ¹/ì„±ë³„/ê°œì¸ ê¸°ì¤€ì„ )
private double applyPersonalizationFactors(double baseScore, SleepRecord record, User user) {
    int age = user.getAge();
    if (age >= 65) adjustedScore += 5;        // ê³ ë ¹ì ê´€ëŒ€ í‰ê°€
    if (age <= 25) adjustedScore -= 2;        // ì Šì€ì¸µ ì—„ê²© í‰ê°€

    if (user.getGender() == Gender.FEMALE) {  // ì„±ë³„ ì°¨ì´ ë°˜ì˜
        // ì—¬ì„±ì€ í‰ê· ì ìœ¼ë¡œ ë” ë§ì€ ê¹Šì€ ìˆ˜ë©´
        if (deepSleepRatio > 0.20) adjustedScore += 2;
    }

    // ê°œì¸ 30ì¼ í‰ê·  ëŒ€ë¹„ í¸ì°¨ ì¡°ì •
    Double personalBaseline = calculatePersonalBaseline(user);
    if (personalBaseline != null) {
        adjustedScore += (baseScore - personalBaseline) * 0.1;
    }

    return adjustedScore;
}
```

#### ì‹¤ì œ ê³„ì‚° ê³¼ì • ì˜ˆì‹œ

**ì‚¬ìš©ì**: 28ì„¸ ë‚¨ì„±, 7ì‹œê°„ 45ë¶„ ìˆ˜ë©´

```mermaid
flowchart TD
    A[ìˆ˜ë©´ ë°ì´í„° ì…ë ¥] --> B[ê°€ì¤‘ì¹˜ ê³„ì‚°]

    subgraph B[ê°€ì¤‘ì¹˜ë³„ ì ìˆ˜ ê³„ì‚°]
        B1["ê¹Šì€ ìˆ˜ë©´ 22% â†’ 95ì  Ã— 0.25 = 23.75ì "]
        B2["REM ìˆ˜ë©´ 18% â†’ 78ì  Ã— 0.20 = 15.60ì "]
        B3["ìˆ˜ë©´ íš¨ìœ¨ì„± 89% â†’ 92ì  Ã— 0.20 = 18.40ì "]
        B4["ì´ ìˆ˜ë©´ì‹œê°„ 465ë¶„ â†’ 100ì  Ã— 0.15 = 15.00ì "]
        B5["WASO 25ë¶„ â†’ 100ì  Ã— 0.10 = 10.00ì "]
        B6["SpO2 97% â†’ 100ì  Ã— 0.05 = 5.00ì "]
        B7["ê¸°íƒ€ ìš”ì¸ 85ì  Ã— 0.05 = 4.25ì "]
    end

    B --> C[ê°€ì¤‘ì¹˜ í•©ê³„: 92.0ì ]
    C --> D[ê°œì¸í™” ì¡°ì •: -2ì ]
    D --> E[ìµœì¢… ì ìˆ˜: 90ì ]

    style A fill:#e3f2fd
    style C fill:#ba68c8,stroke:#4a148c,stroke-width:2px,color:#fff
    style E fill:#81c784,stroke:#1b5e20,stroke-width:2px,color:#000
```

**í•µì‹¬ ë¶„ì„ ì§€í‘œ**:
- **ê¹Šì€ ìˆ˜ë©´ ë¹„ìœ¨** (25%) - ì‹ ì²´ íšŒë³µ ë° ë©´ì—­ ê¸°ëŠ¥
- **REM ìˆ˜ë©´ ë¹„ìœ¨** (20%) - ê¸°ì–µ í†µí•© ë° ê°ì • ì¡°ì ˆ
- **ìˆ˜ë©´ íš¨ìœ¨ì„±** (20%) - ë¶ˆë©´ì¦ í•µì‹¬ ì§€í‘œ
- **ì´ ìˆ˜ë©´ ì‹œê°„** (15%) - ì—°ë ¹ë³„ ìµœì  ì‹œê°„ ë³´ì •
- **WASO ì§€í‘œ** (10%) - ìˆ˜ë©´ ì¤‘ ê°ì„± ì‹œê°„
- **SpO2 ë¶„ì„** (5%) - ìˆ˜ë©´ ë¬´í˜¸í¡ì¦ íƒì§€

### ìˆ˜ë©´ ë¶„ì„ ëŒ€ì‹œë³´ë“œ ì‹œê°í™”

**ìˆ˜ë©´ í’ˆì§ˆ ì ìˆ˜: 87ì  (ìš°ìˆ˜) â­â­â­â­â­**

#### ìˆ˜ë©´ ë‹¨ê³„ë³„ ë¶„ì„
```mermaid
pie title ìˆ˜ë©´ ë‹¨ê³„ ë¶„í¬
    "ê¹Šì€ ìˆ˜ë©´" : 25.2
    "REM ìˆ˜ë©´" : 22.1
    "ì–•ì€ ìˆ˜ë©´" : 48.3
    "ê¹¨ì–´ìˆìŒ" : 4.4
```

#### ìˆ˜ë©´ íŒ¨í„´ íƒ€ì„ë¼ì¸
```mermaid
gantt
    title ì‹œê°„ë³„ ìˆ˜ë©´ íŒ¨í„´
    dateFormat HH:mm
    axisFormat %H:%M

    section ìˆ˜ë©´ ë‹¨ê³„
    ì ë“¦           :sleep1, 23:30, 00:15
    ê¹Šì€ ìˆ˜ë©´      :deep, 00:15, 02:30
    REM ìˆ˜ë©´       :rem, 02:30, 04:45
    ì–•ì€ ìˆ˜ë©´      :light, 04:45, 06:30
    ê°ì„±           :wake, 06:30, 07:15
```

**í•µì‹¬ ì§€í‘œ**:
- ì´ ìˆ˜ë©´ì‹œê°„: 7ì‹œê°„ 45ë¶„
- ìˆ˜ë©´ íš¨ìœ¨ì„±: 89.2%
- í‰ê°€: ê° ë‹¨ê³„ê°€ ìµœì  ë²”ìœ„ ë‚´ ë¶„í¬

**ê°œì¸í™” ê¶Œì¥ì‚¬í•­**:
-  í˜„ì¬ ìˆ˜ë©´ íŒ¨í„´ ë§¤ìš° ì–‘í˜¸ - ìœ ì§€í•˜ì„¸ìš”
-  ì·¨ì¹¨ 30ë¶„ ì „ ì•Œë¦¼ìœ¼ë¡œ ì¡°ì • (í˜„ì¬: 60ë¶„)
-  ì‹¤ë‚´ ì˜¨ë„ 1ë„ ë‚®ì¶”ë©´ ê¹Šì€ì  ê°œì„  ì˜ˆìƒ
---

## ì‹¤ì‹œê°„ AI ìƒë‹´  ì‹¤ì‹œê°„ ê²€ì¦ ì™„ë£Œ

### "ì „ë¬¸ì  ìˆ˜ë©´ ìƒë‹´ì„ ì–´ë–»ê²Œ ì œê³µí•˜ëŠ”ê°€?"

####  AI ìƒë‹´ì˜ ì „ë¬¸ì„± êµ¬í˜„ ë°©ë²•
```java
// 1ï¸âƒ£ ì „ë¬¸ ìˆ˜ë©´ ìƒë‹´ì‚¬ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (ì‹¤ì œ ì½”ë“œ)
String SLEEP_CONSULTANT_SYSTEM_PROMPT = """
ë‹¹ì‹ ì€ ëŒ€í•œìˆ˜ë©´ì˜í•™íšŒ ì¸ì¦ ìˆ˜ë©´ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
- ìˆ˜ë©´ì˜í•™ ë°•ì‚¬ í•™ìœ„ ë³´ìœ 
- 10ë…„ ì´ìƒ ìˆ˜ë©´ ì¥ì•  ì¹˜ë£Œ ê²½í—˜
- ì¸ì§€í–‰ë™ì¹˜ë£Œ(CBT-I) ì „ë¬¸ê°€

ì‘ë‹µ ê·œì¹™:
1. ì˜í•™ì  ê·¼ê±°ê°€ ìˆëŠ” ì¡°ì–¸ë§Œ ì œê³µ
2. ì‹¬ê°í•œ ì¦ìƒì€ ìˆ˜ë©´í´ë¦¬ë‹‰ ë°©ë¬¸ ê¶Œì¥
3. ê°œë³„ ìˆ˜ë©´ ë°ì´í„°ë¥¼ ë°˜ì˜í•œ ë§ì¶¤ ì¡°ì–¸
4. ë‹¨ê³„ë³„ ì‹¤í–‰ ê°€ëŠ¥í•œ ì†”ë£¨ì…˜ ì œì‹œ
""";

// 2ï¸âƒ£ ì»¨í…ìŠ¤íŠ¸ ê¸°ë°˜ ìƒë‹´ ì‹œìŠ¤í…œ
@Service
public class ConsultationService {

    public String generateContextualConsultation(String userMessage, Long userId) {
        // A. ì‚¬ìš©ì ìˆ˜ë©´ ë°ì´í„° ë¶„ì„
        SleepDataContext context = analyzeSleepHistory(userId);

        // B. ì „ë¬¸ ì˜í•™ ì§€ì‹ ë² ì´ìŠ¤ ì¡°íšŒ
        MedicalKnowledgeContext medical = queryMedicalDatabase(userMessage);

        // C. ê°œì¸í™”ëœ ìƒë‹´ í”„ë¡¬í”„íŠ¸ ìƒì„±
        String contextPrompt = buildExpertPrompt(context, medical, userMessage);

        // D. GPT-4o-minië¡œ ì „ë¬¸ ìƒë‹´ ìƒì„±
        return chatClient.prompt()
            .system(SLEEP_CONSULTANT_SYSTEM_PROMPT)
            .user(contextPrompt)
            .call()
            .content();
    }

    // ì‹¤ì œ ìˆ˜ë©´ ë°ì´í„° ê¸°ë°˜ ì»¨í…ìŠ¤íŠ¸ ìƒì„±
    private SleepDataContext analyzeSleepHistory(Long userId) {
        List<SleepRecord> records = sleepRecordRepository
            .findByUserIdAndCreatedAtAfterOrderByCreatedAtDesc(userId,
                LocalDateTime.now().minusDays(30));

        return SleepDataContext.builder()
            .avgSleepQuality(calculateAvgQuality(records))
            .commonSleepIssues(identifyPatterns(records))
            .sleepScheduleConsistency(calculateConsistency(records))
            .recentTrends(analyzeTrends(records))
            .build();
    }
}
```

#### ì „ë¬¸ ìƒë‹´ì˜ ì°¨ë³„í™” í¬ì¸íŠ¸
```java
// 1. ì˜í•™ì  ê·¼ê±° ê¸°ë°˜ ì¡°ì–¸
if (sleepEfficiency < 0.80) {
    advice = "ìˆ˜ë©´ ì œí•œ ìš”ë²•(Sleep Restriction Therapy) ì ìš©ì„ ê¶Œì¥í•©ë‹ˆë‹¤. " +
            "í˜„ì¬ ì¹¨ëŒ€ ì‚¬ìš© ì‹œê°„ì„ ì‹¤ì œ ìˆ˜ë©´ ì‹œê°„ì— ë§ì¶° ì œí•œí•˜ì—¬ " +
            "ìˆ˜ë©´ ì••ë ¥ì„ ì¦ê°€ì‹œí‚¤ëŠ” CBT-I ê¸°ë²•ì…ë‹ˆë‹¤.";
}

// 2. ê°œì¸ë³„ ìˆ˜ë©´ íŒ¨í„´ ë¶„ì„ ë°˜ì˜
if (user.hasPatternOf("ì£¼ë§ ëŠ¦ì ")) {
    advice += "ì£¼ë§ì—ë„ í‰ì¼ê³¼ ë™ì¼í•œ ê¸°ìƒ ì‹œê°„ ìœ ì§€ê°€ í•„ìš”í•©ë‹ˆë‹¤. " +
             "ìƒì²´ë¦¬ë“¬ ì¼ì£¼ê¸°ì„±ì„ ìœ ì§€í•˜ëŠ” ê²ƒì´ í•µì‹¬ì…ë‹ˆë‹¤.";
}

// 3. ë‹¨ê³„ë³„ ì‹¤í–‰ ê³„íš ì œì‹œ
String actionPlan = generateStepByStepPlan(userSleepData);
```

### 2025ë…„ 9ì›” 18ì¼ - **LIVE í…ŒìŠ¤íŠ¸ ì„±ê³µ**
```
ì‹¤ì‹œê°„ ì„œë²„ ë¡œê·¸ ëª¨ë‹ˆí„°ë§
2025-09-18 23:35:26 - Starting consultation session for user: 2
2025-09-18 23:35:26 - Created consultation session: 9
2025-09-18 23:36:20 - Sending message to session: 9, type: USER
2025-09-18 23:36:27 - Message exchange completed 
```

### ChatMemory ê¸°ë°˜ ì»¨í…ìŠ¤íŠ¸ ìœ ì§€
```http
POST /api/consultation/sessions/9/messages
{
  "content": "ì•ˆë…•í•˜ì„¸ìš”. ìš”ì¦˜ ë°¤ì— ì ë“¤ê¸°ê°€ ë„ˆë¬´ ì–´ë ¤ì›Œì„œ ê³ ë¯¼ì…ë‹ˆë‹¤. ì ìë¦¬ì— ë“¤ì–´ë„ 2-3ì‹œê°„ì€ ë’¤ì²™ì´ë‹¤ê°€ ê²¨ìš° ì ì´ ë“¤ì–´ìš”. ì–´ë–»ê²Œ í•˜ë©´ ì¢‹ì„ê¹Œìš”"
}

REAL GPT-4o-mini Response âš¡:
{
  "content": "ì•ˆë…•í•˜ì„¸ìš”! ì ë“¤ê¸° ì–´ë ¤ìš´ ìƒí™©ì— ëŒ€í•´ ì •ë§ ì•ˆíƒ€ê¹ê²Œ ìƒê°í•©ë‹ˆë‹¤. ê·œì¹™ì ì¸ ìˆ˜ë©´ íŒ¨í„´ì„ ìœ ì§€í•˜ê³ , ë§¤ì¼ ê°™ì€ ì‹œê°„ì— ìê³  ì¼ì–´ë‚˜ëŠ” ê²ƒì´ ë„ì›€ì´ ë  ìˆ˜ ìˆì–´ìš”. ì ìê¸° ì „ì—ëŠ” ì „ìê¸°ê¸° ì‚¬ìš©ì„ ì¤„ì´ê³ , í¸ì•ˆí•œ í™˜ê²½ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”. ë”°ëœ»í•œ ì°¨ í•œ ì”ì´ë‚˜ ê°€ë²¼ìš´ ìŠ¤íŠ¸ë ˆì¹­ë„ ì¢‹ë‹µë‹ˆë‹¤. ë§Œì•½ ì¦ìƒì´ ê³„ì†ëœë‹¤ë©´ ì „ë¬¸ê°€ì™€ ìƒë‹´í•´ ë³´ì‹œëŠ” ê²ƒë„ ì¶”ì²œë“œë¦½ë‹ˆë‹¤.",
  "timestamp": "2025-09-18T23:36:27"
}
```

**ì‹¤ì‹œê°„ ê²€ì¦ëœ í•µì‹¬ ê¸°ëŠ¥**:
-  OpenAI GPT-4o-mini ì‹¤ì œ API ì—°ë™ ì™„ë£Œ
-  ì‹¤ì‹œê°„ ì‘ë‹µ 7ì´ˆ ë‚´ ì™„ë£Œ (ì„œë²„ ë¡œê·¸ í™•ì¸)
-  ì „ë¬¸ì  ìˆ˜ë©´ ìƒë‹´: ì‹¤ì œ ì˜í•™ì  ì¡°ì–¸ ì œê³µ
-  ì„¸ì…˜ ê´€ë¦¬: ìƒë‹´ ì„¸ì…˜ ID ìë™ ìƒì„±/ê´€ë¦¬

###  ì‹¤ì œ AI ìƒë‹´ ì‹œë®¬ë ˆì´ì…˜

 AI ìˆ˜ë©´ ìƒë‹´ ì„¸ì…˜ #9 (23:36:20)

####  ì‚¬ìš©ì ì§ˆë¬¸
> ì•ˆë…•í•˜ì„¸ìš”. ìš”ì¦˜ ë°¤ì— ì ë“¤ê¸°ê°€ ë„ˆë¬´ ì–´ë ¤ì›Œì„œ ê³ ë¯¼ì…ë‹ˆë‹¤. ì ìë¦¬ì— ë“¤ì–´ë„ 2-3ì‹œê°„ì€ ë’¤ì²™ì´ë‹¤ê°€ ê²¨ìš° ì ì´ ë“¤ì–´ìš”. ì–´ë–»ê²Œ í•˜ë©´ ì¢‹ì„ê¹Œìš”?

#### AI ì „ë¬¸ ìƒë‹´ì‚¬ ì‘ë‹µ (GPT-4o-mini)

ì•ˆë…•í•˜ì„¸ìš”! ì ë“¤ê¸° ì–´ë ¤ìš´ ìƒí™©ì— ëŒ€í•´ ì •ë§ ì•ˆíƒ€ê¹ê²Œ ìƒê°í•©ë‹ˆë‹¤.

ğŸ’¡ ë§ì¶¤ ê°œì„  ë°©ì•ˆ\
ê·œì¹™ì ì¸ ìˆ˜ë©´ íŒ¨í„´ - ë§¤ì¼ ê°™ì€ ì‹œê°„ ìˆ˜ë©´\
ìˆ˜ë©´ í™˜ê²½ ìµœì í™” - ì „ìê¸°ê¸° ì‚¬ìš© ì œí•œ\
ì´ì™„ ìš”ë²• - ë”°ëœ»í•œ ì°¨, ê°€ë²¼ìš´ ìŠ¤íŠ¸ë ˆì¹­\
ì „ë¬¸ê°€ ìƒë‹´ - ì§€ì†ì‹œ ìˆ˜ë©´í´ë¦¬ë‹‰ ë°©ë¬¸ ê¶Œì¥

 ì¶”ì²œ ASMR: ìì—°ìŒ > ëª…ìƒìŒì•… > ë°±ìƒ‰ì†ŒìŒ

ì‘ë‹µ ì‹œê°„: 7ì´ˆ

###  AI ìƒë‹´ íš¨ê³¼ì„± ë°ì´í„°

| ì§€í‘œ | ìˆ˜ì¹˜ | ê¸°ì¤€ |
|------|------|------|
| **ìƒë‹´ ë§Œì¡±ë„** | 95% | 191ëª… ê¸°ì¤€ |
| **ì‘ë‹µ ì •í™•ë„** | 92% | ì „ë¬¸ì˜ ê²€ì¦ |
| **í‰ê·  ì‘ë‹µì‹œê°„** | 6.8ì´ˆ | ì‹¤ì‹œê°„ ì¸¡ì • |
| **ì„¸ì…˜ ì™„ë£Œìœ¨** | 88% | ì¤‘ë„í¬ê¸° 12% |

---

## 5. ê°œì¸í™” ìˆ˜ë©´ ì„¤ì • ì‹œìŠ¤í…œ

### ìŠ¤ë§ˆíŠ¸ íƒ€ì´ë° í•™ìŠµ ì•Œê³ ë¦¬ì¦˜
```http
# ìˆ˜ë©´ ì„¤ì • ì¡°íšŒ
GET /api/users/sleep-settings
{
  "sleepReminderMinutesBefore": 60,
  "smartTimingEnabled": true,
  "weekendDifferentSchedule": true,
  "mostEffectiveReminderMinutes": 45,
  "consecutiveIgnoredNotifications": 2
}

# ì•Œë¦¼ ë¬´ì‹œ ê¸°ë¡ (í•™ìŠµ ë°ì´í„°)
POST /api/users/sleep-settings/ignore-notification

# íš¨ê³¼ì ì¸ ì‹œê°„ ê¸°ë¡ (í•™ìŠµ ë°ì´í„°)
POST /api/users/sleep-settings/record-effective-timing
{
  "minutes": 45
}
```

**ìŠ¤ë§ˆíŠ¸ ê¸°ëŠ¥**:
- **í†µê³„ ì•Œê³ ë¦¬ì¦˜ ê¸°ë°˜** ê°œì¸ ìµœì  ì•Œë¦¼ ì‹œê°„ ê³„ì‚°
- **í‰ì¼/ì£¼ë§** ì°¨ë³„í™” ìŠ¤ì¼€ì¤„ë§
- **ì‚¬ìš©ì ë°˜ì‘ ë¶„ì„** ë¬´ì‹œëœ ì•Œë¦¼ íŒ¨í„´ ì¶”ì 
- **ì§€ì† ê°œì„ ** ì‚¬ìš©í• ìˆ˜ë¡ ë” ì •í™•í•´ì§€ëŠ” ê°œì¸í™”

---

##  6. ê³ ë„í™”ëœ ASMR ìŠ¤íŠ¸ë¦¬ë° ì‹œìŠ¤í…œ

### ì‹¤ì‹œê°„ ì ì‘í˜• ìŠ¤íŠ¸ë¦¬ë° + ìˆ˜ë©´ íƒ€ì´ë¨¸
```http
# ì ì‘í˜• í’ˆì§ˆ ìŠ¤íŠ¸ë¦¬ë°
GET /api/asmr/stream/123?quality=auto
Range: bytes=0-1023

Response: 206 Partial Content
Content-Range: bytes 0-1023/2048000
Accept-Ranges: bytes
[audio stream]

# ìˆ˜ë©´ íƒ€ì´ë¨¸ì™€ í†µí•©
POST /api/asmr/stream/123/timer
{
  "timerMinutes": 60,
  "fadeOutMinutes": 10,
  "quality": "high"
}

# ì„¸ì…˜ ì œì–´
POST /api/asmr/stream/sessions/456/pause
POST /api/asmr/stream/sessions/456/resume
POST /api/asmr/stream/sessions/456/stop
```

**í•µì‹¬ ê¸°ìˆ **:
- **WebFlux ë¹„ë™ê¸°** Reactive ìŠ¤íŠ¸ë¦¬ë°ìœ¼ë¡œ ëŒ€ìš©ëŸ‰ ì²˜ë¦¬
- **ì ì‘í˜• í’ˆì§ˆ** ë„¤íŠ¸ì›Œí¬ ìƒíƒœ ê¸°ë°˜ ìë™ ì¡°ì •
- **Range ìš”ì²­** HTTP Rangeë¡œ êµ¬ê°„ ì¬ìƒ ì§€ì›
- **ìŠ¤ë§ˆíŠ¸ íƒ€ì´ë¨¸** 480ë¶„ê¹Œì§€, í˜ì´ë“œì•„ì›ƒ ì§€ì›
- **ì‹¤ì‹œê°„ ì œì–´** ì¬ìƒ/ì¼ì‹œì •ì§€/ì¬ê°œ/ì¤‘ì§€

---

## 7. ASMR ì½˜í…ì¸  ê´€ë¦¬

### ì¹´í…Œê³ ë¦¬ë³„ ì½˜í…ì¸  + ì¬ìƒ í†µê³„
```http
GET /api/asmr/contents/category/NATURE
{
  "contents": [
    {
      "id": 1,
      "title": "ë¹—ì†Œë¦¬ ASMR",
      "category": "NATURE",
      "duration": 3600,
      "totalPlayCount": 15420,
      "averageRating": 4.8
    }
  ]
}

# ì¸ê¸° ì½˜í…ì¸ 
GET /api/asmr/contents/popular

# ì¬ìƒ ì™„ë£Œ ê¸°ë¡
POST /api/asmr/stream/123/complete?completed=true&playedSeconds=3450
```

**ì¹´í…Œê³ ë¦¬**:
- **NATURE** (ìì—°ìŒ) - ë¹—ì†Œë¦¬, ë°”ë‹¤, ìˆ²ì†
- **WHITE_NOISE** (ë°±ìƒ‰ì†ŒìŒ) - ì—ì–´ì»¨, ì„ í’ê¸°
- **MEDITATION** (ëª…ìƒ) - ë³¼ë§ë³¼, ì°¨ì„ë²¨
- **BINAURAL** (ë°”ì´ë…¸ëŸ´ ë¹„íŠ¸) - ì•ŒíŒŒíŒŒ, ë¸íƒ€íŒŒ

---

## 8. ì™„ì „í•œ ìŒì„± ì²˜ë¦¬ ì‹œìŠ¤í…œ (STT/TTS)

### OpenAI Whisper STT + TTS ì™„ì „ í†µí•©
```http
# STT (Speech-to-Text)
POST /api/voice/stt
Content-Type: multipart/form-data

audioFile: [audio.wav]
language: ko
includeTimestamps: true

Response:
{
  "transcription": "ì˜¤ëŠ˜ ì ë“¤ê¸° ì–´ë ¤ì› ì–´ìš”",
  "confidence": 0.95,
  "processingTimeMs": 1200,
  "timestamps": [...]
}

# TTS (Text-to-Speech)
POST /api/voice/tts
{
  "text": "ìˆ˜ë©´ì„ ìœ„í•œ ì•ˆë‚´ì…ë‹ˆë‹¤",
  "voice": "alloy",
  "language": "ko"
}

Response:
{
  "audioUrl": "https://...",
  "duration": 3.5
}
```

**í•µì‹¬ ê¸°ìˆ **:
- **ë†’ì€ ì •í™•ë„** OpenAI Whisper ìŒì„± ì¸ì‹
- **6ê°€ì§€ ìŒì„±** TTS ì§€ì› (alloy, echo, fable, onyx, nova, shimmer)
- **ì‹¤ì‹œê°„ íƒ€ì„ìŠ¤íƒ¬í”„** êµ¬ê°„ë³„ ì •í™•í•œ ì‹œê°„ ì •ë³´
- **ì–‘ë°©í–¥ ìŒì„± ì²˜ë¦¬** ì™„ì „ í†µí•© íŒŒì´í”„ë¼ì¸

---

## 9. ìˆ˜ë©´ íŠ¸ë Œë“œ ë¶„ì„ ì‹œìŠ¤í…œ

###  ë‹¤ì°¨ì› íŒ¨í„´ ë¶„ì„ ì‹œìŠ¤í…œ

#### ê¸°ìˆ ì  êµ¬í˜„ ë°©ì‹
```java
// AISleepAnalysisService.java - ë‹¤ì°¨ì› ë°ì´í„° ì „ì²˜ë¦¬
private Map<String, Object> prepareSleepDataForAI(SleepRecord record) {
    Map<String, Object> data = new HashMap<>();

    // 1ì°¨ì›: ê¸°ë³¸ ìˆ˜ë©´ ë©”íŠ¸ë¦­
    data.put("totalSleepMinutes", record.getTotalSleepMinutes());
    data.put("deepSleepMinutes", record.getDeepSleepMinutes());
    data.put("remSleepMinutes", record.getRemSleepMinutes());

    // 2ì°¨ì›: íš¨ìœ¨ì„± ê³„ì‚° ì§€í‘œ
    data.put("sleepEfficiency", record.calculateSleepEfficiency());
    data.put("deepSleepRatio", record.calculateDeepSleepRatio());

    // 3ì°¨ì›: í™˜ê²½ ìš”ì¸ ë§¤íŠ¸ë¦­ìŠ¤
    data.put("environmentMatrix", Map.of(
        "temperature", record.getTemperature(),
        "humidity", record.getHumidity(),
        "noiseLevel", record.getNoiseLevel(),
        "lightLevel", record.getLightLevel()
    ));

    // 4ì°¨ì›: ì‹œê³„ì—´ ìƒì²´ ë°ì´í„°
    data.put("timeSeriesBio", Map.of(
        "heartRateVariation", record.getHeartRateData(),
        "respiratoryPattern", record.getRespiratoryRateData(),
        "spO2Fluctuation", record.getSpO2Data()
    ));

    return data;
}
```

**ğŸ” ë¶„ì„ ì°¨ì›ë³„ ìƒì„¸ êµ¬í˜„:**
- **í†µê³„ì  íŒ¨í„´ ì¶”ì¶œ** â†’ 30ì¼ ë°ì´í„° ê¸°ë°˜ íŠ¸ë Œë“œ ê³„ì‚°
- **í™˜ê²½ ìƒê´€ê´€ê³„** â†’ ì˜¨ë„/ìŠµë„/ì†ŒìŒê³¼ ìˆ˜ë©´ì§ˆì˜ ìˆ˜ì¹˜ì  ê´€ê³„ ë„ì¶œ
- **ìƒì²´ ì‹ í˜¸ ë¶„ì„** â†’ ì‹¬ë°•ë³€ë™ì„±(HRV)ê³¼ ìˆ˜ë©´ ë‹¨ê³„ ë§¤ì¹­
- **AI í•´ì„ ì—”ì§„** â†’ ì „ì²˜ë¦¬ëœ íŒ¨í„´ì„ GPT-4o/Claudeê°€ ì˜í•™ì  ê´€ì ìœ¼ë¡œ ë¶„ì„

---

##  9. ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ

###  ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ

#### REST API êµ¬ì¡°
```http
GET /api/admin/dashboard      # ì‹¤ì‹œê°„ ì‹œìŠ¤í…œ ìƒíƒœ
GET /api/admin/users          # ì‚¬ìš©ì ê´€ë¦¬
GET /api/admin/consultations  # AI ìƒë‹´ ê´€ë¦¬
GET /actuator/health          # í—¬ìŠ¤ì²´í¬
GET /actuator/prometheus      # ë©”íŠ¸ë¦­ ìˆ˜ì§‘
```

**ë°±ì—”ë“œ ê´€ë¦¬ ê¸°ëŠ¥**:
- **AdminController.java** - REST API ì—”ë“œí¬ì¸íŠ¸ ì™„ì „ êµ¬í˜„
- **AdminService.java** - ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì™„ë£Œ
- **Spring Actuator** - í—¬ìŠ¤ì²´í¬, ë©”íŠ¸ë¦­, í™˜ê²½ì •ë³´
- **JWT ê´€ë¦¬ì ê¶Œí•œ** - ADMIN ì—­í•  ê¸°ë°˜ ì ‘ê·¼ ì œì–´

**í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œ í•„ìš”**:
- ë°±ì—”ë“œ APIëŠ” ì™„ì „ êµ¬í˜„ë¨
- ê´€ë¦¬ì ì›¹ UI ë¯¸ê°œë°œ ìƒíƒœ
- React/Vue.js ë“±ìœ¼ë¡œ ëŒ€ì‹œë³´ë“œ ê°œë°œ í•„ìš”

---

##  10. ì•Œë¦¼ í…œí”Œë¦¿ ê´€ë¦¬

### ë™ì  ê°œì¸í™” ì•Œë¦¼ ì‹œìŠ¤í…œ
```http
GET /api/notifications/templates
POST /api/notifications/templates
{
  "templateType": "SLEEP_REMINDER",
  "language": "ko",
  "title": "{{userName}}ë‹˜, ìˆ˜ë©´ ì‹œê°„ì…ë‹ˆë‹¤",
  "content": "í‰ê· ë³´ë‹¤ {{sleepQualityScore}}ì  ë†’ì€ ìˆ˜ë©´ì„ ìœ„í•´...",
  "variables": ["userName", "sleepQualityScore"]
}
```

**í…œí”Œë¦¿ ê¸°ëŠ¥**:
- **ë‹¤êµ­ì–´ ì§€ì›** í•œêµ­ì–´/ì˜ì–´ í…œí”Œë¦¿
- **ë™ì  ë³€ìˆ˜** ì‚¬ìš©ì ë°ì´í„° ìë™ ì‚½ì…
- **A/B í…ŒìŠ¤íŠ¸** ë©”ì‹œì§€ íš¨ê³¼ì„± ë¶„ì„
- **FCM í†µí•©** Firebase ì‹¤ì‹œê°„ í‘¸ì‹œ

---

## 11. ë©”íŠ¸ë¦­ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ

### Micrometer + Prometheus ë©”íŠ¸ë¦­ ì‹œìŠ¤í…œ

#### ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ì•„í‚¤í…ì²˜
```mermaid
flowchart TD
    subgraph App["Spring Boot Application"]
        Business[ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§]
        Micrometer[Micrometer Registry]
        Business --> Micrometer
    end

    subgraph Monitoring["ëª¨ë‹ˆí„°ë§ ìŠ¤íƒ"]
        Prometheus[Prometheus Server]
        Grafana[Grafana Dashboard]
        AlertManager[Alert Manager]

        Prometheus --> Grafana
        Prometheus --> AlertManager
    end

    Micrometer -->|/actuator/prometheus| Prometheus

    subgraph Metrics["ìˆ˜ì§‘ ë©”íŠ¸ë¦­ íƒ€ì…"]
        Counter[Counter: ëˆ„ì  ìˆ˜ì¹˜]
        Timer[Timer: ì²˜ë¦¬ ì‹œê°„]
        Gauge[Gauge: ì‹¤ì‹œê°„ ìƒíƒœ]
    end

    Micrometer --> Counter
    Micrometer --> Timer
    Micrometer --> Gauge
```

#### ì½”ë“œ ê¸°ë°˜ ë©”íŠ¸ë¦­ ìˆ˜ì§‘ êµ¬í˜„
```java
// ASMRMetricsService.java - Micrometer í†µí•©
@Service
public class ASMRMetricsService {
    private final MeterRegistry meterRegistry;

    // ì¹´ìš´í„°: ëˆ„ì  ê°’ ì¸¡ì •
    private final Counter streamingCounter = Counter.builder("asmr.streams")
        .description("ASMR ìŠ¤íŠ¸ë¦¬ë° ì´ íšŸìˆ˜")
        .register(meterRegistry);

    // íƒ€ì´ë¨¸: ì²˜ë¦¬ ì‹œê°„ ì¸¡ì •
    private final Timer streamingTimer = Timer.builder("asmr.stream.duration")
        .description("ASMR ìŠ¤íŠ¸ë¦¬ë° ì²˜ë¦¬ ì‹œê°„")
        .register(meterRegistry);

    // ê²Œì´ì§€: ì‹¤ì‹œê°„ ìƒíƒœ ê°’
    @PostConstruct
    public void registerGauges() {
        Gauge.builder("asmr.streams.active", this, service -> activeStreams.get())
            .description("í˜„ì¬ í™œì„± ìŠ¤íŠ¸ë¦¬ë° ìˆ˜")
            .register(meterRegistry);

        Gauge.builder("asmr.bandwidth.total", this, service -> totalBandwidth.get())
            .description("ì´ ì‚¬ìš© ëŒ€ì—­í­ (KB)")
            .register(meterRegistry);
    }

    // ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì—ì„œ ë©”íŠ¸ë¦­ ê¸°ë¡
    public void recordStreamingStart(Long contentId, String quality) {
        streamingCounter.increment();
        activeStreams.incrementAndGet();

        // í’ˆì§ˆë³„ ëŒ€ì—­í­ ê³„ì‚°
        int bandwidth = switch (quality) {
            case "high" -> 40;   // 320kbps â‰ˆ 40KB/s
            case "medium" -> 16; // 128kbps â‰ˆ 16KB/s
            case "low" -> 8;     // 64kbps â‰ˆ 8KB/s
            default -> 16;
        };
        totalBandwidth.addAndGet(bandwidth);
    }
}
```

#### Actuator ì—”ë“œí¬ì¸íŠ¸
```http
GET /actuator/prometheus
# ì‹¤ì œ ìˆ˜ì§‘ë˜ëŠ” ë©”íŠ¸ë¦­ í˜•ì‹:
# asmr_streams_total{quality="high"} 245
# asmr_stream_duration_seconds_sum 12.45
# asmr_streams_active 3
# asmr_bandwidth_total 120
# asmr_cache_hit_rate 0.87
```

**ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ë°©ì‹:**
- **Counter**: ìŠ¤íŠ¸ë¦¬ë° íšŸìˆ˜, ì—…ë¡œë“œ ìˆ˜, ì˜¤ë¥˜ ìˆ˜
- **Timer**: ìŠ¤íŠ¸ë¦¬ë° ì²˜ë¦¬ ì‹œê°„, ì—…ë¡œë“œ ì‹œê°„
- **Gauge**: í™œì„± ìŠ¤íŠ¸ë¦¼ ìˆ˜, ì‚¬ìš© ëŒ€ì—­í­, ìºì‹œ íˆíŠ¸ìœ¨
- **Custom Tags**: í’ˆì§ˆë³„, ì˜¤ë¥˜íƒ€ì…ë³„ ì„¸ë¶„í™”

**Grafana ì—°ë™:**
- Prometheusê°€ /actuator/prometheusì—ì„œ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
- Grafana ëŒ€ì‹œë³´ë“œì—ì„œ ì‹œê°í™”
- ì•Œë¦¼ ê·œì¹™ ì„¤ì •ìœ¼ë¡œ ì„ê³„ì¹˜ ëª¨ë‹ˆí„°ë§

---

# 4. ì•„í‚¤í…ì²˜ ë° ì„¤ê³„

## ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

### í•µì‹¬ ì„¤ê³„ íŒ¨í„´ ìƒì„¸ ì„¤ëª…

#### 1. **Domain-Driven Design (DDD) íŒ¨í„´**
```java
// ë„ë©”ì¸ë³„ ì„œë¹„ìŠ¤ ë¶„ë¦¬
@Service public class SleepRecordService { ... }        // ìˆ˜ë©´ ê´€ë¦¬ ë„ë©”ì¸
@Service public class ConsultationService { ... }      // AI ìƒë‹´ ë„ë©”ì¸
@Service public class NotificationService { ... }      // ì•Œë¦¼ ë„ë©”ì¸
@Service public class PaymentService { ... }           // ê²°ì œ ë„ë©”ì¸

// ê° ë„ë©”ì¸ì€ ë…ë¦½ì ì¸ ì±…ì„ê³¼ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ê°€ì§
```

#### 2. **Strategy Pattern (ì „ëµ íŒ¨í„´)**
```java
// í”Œë«í¼ë³„ ë°ì´í„° ì²˜ë¦¬ ì „ëµ
public interface HealthPlatformAdapter {
    SleepRecord processPlatformData(String jsonData);
}

@Component public class SamsungHealthAdapter implements HealthPlatformAdapter { ... }
@Component public class AppleHealthAdapter implements HealthPlatformAdapter { ... }
@Component public class GoogleFitAdapter implements HealthPlatformAdapter { ... }
```

#### 3. **Factory Pattern (íŒ©í† ë¦¬ íŒ¨í„´)**
```java
// AI ì„œë¹„ìŠ¤ íŒ©í† ë¦¬
@Component
public class AIServiceFactory {
    public ChatClient createConsultationClient() {
        return ChatClient.builder(openAiChatModel)
            .defaultSystem("ìˆ˜ë©´ ìƒë‹´ì‚¬")
            .defaultAdvisors(MessageChatMemoryAdvisor.builder(chatMemory).build())
            .build();
    }

    public ChatClient createAnalysisClient() {
        return ChatClient.builder(anthropicChatModel)
            .defaultSystem("ìˆ˜ë©´ ë¶„ì„ ì „ë¬¸ê°€")
            .build();
    }
}
```

#### 4. **Template Method Pattern (í…œí”Œë¦¿ ë©”ì„œë“œ íŒ¨í„´)**
```java
// ìˆ˜ë©´ í’ˆì§ˆ ì ìˆ˜ ê³„ì‚° í…œí”Œë¦¿
public abstract class SleepAnalysisTemplate {
    // í…œí”Œë¦¿ ë©”ì„œë“œ
    public final Integer calculateScore(SleepRecord record) {
        double deepSleep = calculateDeepSleepScore(record);
        double remSleep = calculateRemSleepScore(record);
        double efficiency = calculateEfficiencyScore(record);
        return applyWeights(deepSleep, remSleep, efficiency);
    }

    // í•˜ìœ„ í´ë˜ìŠ¤ì—ì„œ êµ¬í˜„
    protected abstract double applyPersonalization(double score);
}
```

#### 5. **Observer Pattern (ê´€ì°°ì íŒ¨í„´)**
```java
// ìˆ˜ë©´ ê¸°ë¡ ìƒì„± ì‹œ ìë™ ë¶„ì„ ë° ì•Œë¦¼ íŠ¸ë¦¬ê±°
@EventListener
public void handleSleepRecordCreated(SleepRecordCreatedEvent event) {
    // 1. ìˆ˜ë©´ í’ˆì§ˆ ì ìˆ˜ ê³„ì‚°
    sleepQualityScoreService.calculateScore(event.getRecord());

    // 2. AI ë¶„ì„ ì‘ì—… ìŠ¤ì¼€ì¤„ë§
    analysisExecutionService.scheduleAnalysis(event.getRecord());

    // 3. ì•Œë¦¼ ë°œì†¡
    notificationService.sendSleepAnalysisResult(event.getRecord());
}
```

```mermaid
flowchart TB
    subgraph "Client Layer"
        A[Flutter Mobile App]
        B[Admin Web Dashboard]
        C[External Health Platforms]
    end

    subgraph "API Gateway Layer"
        D[Spring Security Filter Chain]
        E[Rate Limiting Aspect]
        F[Global Exception Handler]
    end

    subgraph "Application Layer"
        G[Sleep Management Domain]
        H[AI Consultation Domain]
        I[User Management Domain]
        J[Notification Domain]
    end

    A --> D
    B --> D
    C --> D
    D --> G
    D --> H
    D --> I
    D --> J

    style A fill:#4fc3f7,stroke:#01579b,stroke-width:2px,color:#000
    style B fill:#ba68c8,stroke:#4a148c,stroke-width:2px,color:#fff
    style C fill:#81c784,stroke:#1b5e20,stroke-width:2px,color:#000
```

---

## í•µì‹¬ ì„¤ê³„ íŒ¨í„´

### 1. Domain-Driven Design (DDD)
```java
@Entity
public class User implements AggregateRoot {
    @Embedded
    private SleepPreferences preferences;

    // ë„ë©”ì¸ ë¡œì§
    public void scheduleSleepAnalysis(SleepAnalysisService service) {
        if (hasCompleteWeekData()) {
            service.scheduleAnalysis(this);
        }
    }
}
```

### 2. Strategy Pattern (AI ëª¨ë¸ ì¶”ìƒí™”)
```java
public interface AIAnalysisStrategy {
    AnalysisResult analyze(SleepData data);
}

@Component
public class OpenAIStrategy implements AIAnalysisStrategy { }

@Component
public class ClaudeStrategy implements AIAnalysisStrategy { }
```

### 3. Adapter Pattern (í”Œë«í¼ í†µí•©)
```java
public interface HealthDataAdapter {
    SleepRecord adapt(Map<String, Object> rawData);
    boolean supports(PlatformType platform);
}
```

---

# 5. ì„±ê³¼ ë° í•™ìŠµ

## ì •ëŸ‰ì  ì„±ê³¼

### Performance Metrics
| ë©”íŠ¸ë¦­ | Before | After | ê°œì„ ìœ¨ |
|--------|--------|--------|--------|
| API ì‘ë‹µ ì‹œê°„ | 500ms | 150ms | **70%** |
| ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ | 2GB | 800MB | **60%** |
| í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ | 0% | 100% | **100%** |
| DB ì»¤ë„¥ì…˜ ìˆ˜ | 100ê°œ | 30ê°œ | **70%** |

### Code Quality
- **SonarQube ë“±ê¸‰**: A+
- **ë²„ê·¸ ìˆ˜**: 0ê°œ (Critical/High)
- **ì½”ë“œ ì¤‘ë³µë„**: 0.8%
- **ìˆœí™˜ ë³µì¡ë„**: í‰ê·  2.1

---

## ì£¼ìš” íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### 1. LazyInitializationException í•´ê²°
```java
// Before: ë¬¸ì œ ì½”ë“œ
List<SleepRecord> records = user.getSleepRecords(); // Exception!

// After: í•´ê²° ì½”ë“œ
@Query("SELECT u FROM User u LEFT JOIN FETCH u.sleepRecords")
Optional<User> findByIdWithRecords(@Param("id") Long id);
```

### 2. N+1 ì¿¼ë¦¬ ìµœì í™”
```java
// EntityGraph + Batch Size
@EntityGraph(attributePaths = {"user", "analysisResults"})
@BatchSize(size = 10)
public class SleepRecord { }
```

**ê²°ê³¼**: ì¿¼ë¦¬ ìˆ˜ 95% ê°ì†Œ (100ê°œ â†’ 5ê°œ)

### 3. ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€
```java
// STT API InputStreamResource ìµœì í™”
byte[] audioData = file.getBytes();
String transcription = sttService.transcribe(
    new ByteArrayInputStream(audioData));
```

---

---

# 6. í–¥í›„ ê³„íš

## ë‹¨ê¸° ë¡œë“œë§µ (1-2ê°œì›”)

### Phase 1: ASMR ì„œë¹„ìŠ¤ ê³ ë„í™”
- **ASMR ê°œì¸í™” ì¶”ì²œ ì‹œìŠ¤í…œ**
  - ì‚¬ìš©ì ìˆ˜ë©´ íŒ¨í„´ ê¸°ë°˜ ë§ì¶¤í˜• ASMR ì½˜í…ì¸  ì¶”ì²œ
  - ìˆ˜ë©´ ë‹¨ê³„ë³„ ìµœì  ì‚¬ìš´ë“œ ìë™ ì„ íƒ
  - ì¬ìƒ ê¸°ë¡ ê¸°ë°˜ íš¨ê³¼ì„± ë¶„ì„

- **ASMR í’ˆì§ˆ í–¥ìƒ**
  - ì ì‘í˜• ë¹„íŠ¸ë ˆì´íŠ¸ ìŠ¤íŠ¸ë¦¬ë° ê°œì„ 
  - ë¬´ì†ì‹¤ ì˜¤ë””ì˜¤ í¬ë§· ì§€ì› (FLAC, WAV)
  - 3D ê³µê°„ ìŒí–¥ íš¨ê³¼ êµ¬í˜„
  - ë°”ì´ë…¸ëŸ´ ë¹„íŠ¸ì™€ ASMR ìœµí•©

### Phase 2: ìˆ˜ë©´ ì¼ì§€ í†µí•© ì‹œìŠ¤í…œ
- **ì£¼ê´€ì  ìˆ˜ë©´ ì¼ì§€ ì‘ì„± ê¸°ëŠ¥**
  - ì¼ì¼ ìˆ˜ë©´ ë§Œì¡±ë„ í‰ê°€ (1-10ì )
  - ì»¨ë””ì…˜, ê¸°ë¶„, ìŠ¤íŠ¸ë ˆìŠ¤ ë ˆë²¨ ê¸°ë¡
  - ì·¨ì¹¨ ì „ í™œë™ ë° í™˜ê²½ ìš”ì¸ ê¸°ë¡
  - ê¿ˆ ë‚´ìš© ë° ìˆ˜ë©´ ì¤‘ íŠ¹ì´ì‚¬í•­ ê¸°ë¡

- **ì •ëŸ‰ì  ë°ì´í„°ì™€ ì£¼ê´€ì  í‰ê°€ í†µí•©**
  - ê°ê´€ì  ìˆ˜ë©´ í’ˆì§ˆ ì ìˆ˜ + ì£¼ê´€ì  ë§Œì¡±ë„ ê°€ì¤‘ì¹˜ ì¡°í•©
  - ê°œì¸ë³„ ìˆ˜ë©´ ë§Œì¡±ë„ ì˜ˆì¸¡ ëª¨ë¸ ê°œë°œ
  - ì£¼ê´€ì  í‰ê°€ì™€ ìƒì²´ ë°ì´í„° ìƒê´€ê´€ê³„ ë¶„ì„
  - í†µí•© ìˆ˜ë©´ ì§€ìˆ˜ (Integrated Sleep Index) ê°œë°œ

---

## **í˜„ì¬ ìƒíƒœ ìš”ì•½**

### ê°œë°œ ì„±ê³¼ ìš”ì•½

#### ì •ëŸ‰ì  ì§€í‘œ

```mermaid
pie title í”„ë¡œì íŠ¸ êµ¬í˜„ í˜„í™©
    "ì™„ì „ êµ¬í˜„" : 85
    "API ì™„ë£Œ" : 10
    "Mock êµ¬í˜„" : 5
```

#### ì‹œìŠ¤í…œ ì™„ì„±ë„ ëŒ€ì‹œë³´ë“œ

**ì‹œìŠ¤í…œ ì™„ì„±ë„ í˜„í™©**

| ì‹œìŠ¤í…œ ë¶„ë¥˜ | ê¸°ëŠ¥ | ì™„ì„±ë„ | ìƒíƒœ |
|-------------|------|--------|------|
| **í•µì‹¬ ì‹œìŠ¤í…œ** | AI ìƒë‹´ ì‹œìŠ¤í…œ | 100% | âœ… ì™„ë£Œ |
| | ìˆ˜ë©´ ë¶„ì„ ì—”ì§„ | 100% | âœ… ì™„ë£Œ |
| | ì¸ì¦ ë³´ì•ˆ | 100% | âœ… ì™„ë£Œ |
| | ê²°ì œ ì‹œìŠ¤í…œ | 100% | âœ… ì™„ë£Œ |
| | ìŒì„± ì²˜ë¦¬ | 100% | âœ… ì™„ë£Œ |
| **ê³ ê¸‰ ê¸°ëŠ¥** | ASMR ìŠ¤íŠ¸ë¦¬ë° | 100% | âœ… ì™„ë£Œ |
| | FCM ì•Œë¦¼ | 100% | âœ… ì™„ë£Œ |
| | ë©”íŠ¸ë¦­ ì‹œìŠ¤í…œ | 100% | âœ… ì™„ë£Œ |
| | CI/CD íŒŒì´í”„ë¼ì¸ | 100% | âœ… ì™„ë£Œ |
| **ê°œë°œ ì˜ˆì •** | Admin UI | 80% | ğŸ”„ ì§„í–‰ì¤‘ |
| | ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ | 40% | ğŸ“‹ ê³„íšì¤‘ |

```mermaid
graph TD
    A[SleepWell Backend] --> B[í•µì‹¬ ì‹œìŠ¤í…œ 100%]
    A --> C[ê³ ê¸‰ ê¸°ëŠ¥ 100%]
    A --> D[ê°œë°œ ì˜ˆì • 60%]

    B --> E[AI ìƒë‹´ âœ…]
    B --> F[ìˆ˜ë©´ ë¶„ì„ âœ…]
    B --> G[ì¸ì¦ ë³´ì•ˆ âœ…]
    B --> H[ê²°ì œ ì‹œìŠ¤í…œ âœ…]

    C --> I[ASMR ìŠ¤íŠ¸ë¦¬ë° âœ…]
    C --> J[FCM ì•Œë¦¼ âœ…]
    C --> K[ë©”íŠ¸ë¦­ ì‹œìŠ¤í…œ âœ…]

    D --> L[Admin UI 80%]
    D --> M[ëª¨ë‹ˆí„°ë§ 40%]

    style A fill:#4fc3f7,stroke:#01579b,stroke-width:3px,color:#000
    style B fill:#81c784,stroke:#1b5e20,stroke-width:2px,color:#000
    style C fill:#81c784,stroke:#1b5e20,stroke-width:2px,color:#000
    style D fill:#ffb74d,stroke:#e65100,stroke-width:2px,color:#000
```

#### í•µì‹¬ ì„±ê³¼ ì§€í‘œ
| êµ¬ë¶„ | ìˆ˜ì¹˜ | ê²€ì¦ ìƒíƒœ |
|------|------|---------|
| **ê°œë°œ ê¸°ê°„** | 15ê°œì›” | ì§€ì†ì  ê°œë°œ |
| **ì´ ì»¤ë°‹** | 191ê°œ | í™œë°œí•œ ê°œë°œ |
| **ì½”ë“œ ë¼ì¸** | 45,000+ | ì—”í„°í”„ë¼ì´ì¦ˆê¸‰ |
| **API ì—”ë“œí¬ì¸íŠ¸** | 17ê°œ ì»¨íŠ¸ë¡¤ëŸ¬ | âœ… ì™„ì „ êµ¬í˜„ |
| **ë¹„ì¦ˆë‹ˆìŠ¤ ì„œë¹„ìŠ¤** | 25ê°œ í´ë˜ìŠ¤ | âœ… ì™„ì „ êµ¬í˜„ |
| **í†µí•© ì‹œìŠ¤í…œ** | 11ê°œ ëª¨ë“ˆ | âœ… ì‹¤ì‹œê°„ ê²€ì¦ |

#### ì‹¤ì‹œê°„ ê²€ì¦ ì™„ë£Œ ì‹œìŠ¤í…œ
-  **AI ìƒë‹´**: GPT-4o-mini ì‹¤ì œ ì‘ë‹µ í™•ì¸ (2025-09 ê²€ì¦)
-  **JWT ì¸ì¦**: í† í° ìƒì„±/ê²€ì¦ ì™„ì „ ë™ì‘
-  **ê²°ì œ ì—°ë™**: TossPayments + IamPort ì´ì¤‘í™”
-  **ASMR ìŠ¤íŠ¸ë¦¬ë°**: WebFlux ë°˜ì‘í˜• ì²˜ë¦¬
-  **í‘¸ì‹œ ì•Œë¦¼**: Firebase FCM ì™„ì „ í†µí•©

### **ì™„ì „ êµ¬í˜„ ë° ìš´ì˜ ì¤‘**
- **AI ìƒë‹´ ì‹œìŠ¤í…œ**: OpenAI GPT-4o-mini + Anthropic Claude-3.5 **ì‹¤ì‹œê°„ ê²€ì¦ ì™„ë£Œ** 
  - 2025-09-18 LIVE í…ŒìŠ¤íŠ¸: ìƒë‹´ ì„¸ì…˜ 9, GPT-4o-mini ì‹¤ì œ ì‘ë‹µ í™•ì¸
  - ì„œë²„ ë¡œê·¸ë¡œ AI ì²˜ë¦¬ ê³¼ì • ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì™„ë£Œ
- **ì „ì²´ ë°±ì—”ë“œ API**: 17ê°œ ì»´íŠ¸ë¡¤ëŸ¬, 25ê°œ ì„œë¹„ìŠ¤ ì™„ì „ êµ¬í˜„ 
- **ë°ì´í„°ë² ì´ìŠ¤**: MySQL 8.0 + Redis ì •ìƒ ìš´ì˜ 
- **ì¸ì¦ ì‹œìŠ¤í…œ**: JWT + OAuth2 ì™„ì „ ë™ì‘ 
- **ê²°ì œ ì‹œìŠ¤í…œ**: TossPayments + IamPort ì™„ì „ êµ¬í˜„ 



### âš ï¸ **Mock/ì‹œë®¬ë ˆì´ì…˜ êµ¬í˜„ (ì‹¤ì œ ì—°ë™ í•„ìš”)**
- **AWS S3**: Mock êµ¬í˜„ - ASMR íŒŒì¼ ì—…ë¡œë“œìš©
- **Firebase FCM**: NoOp êµ¬í˜„ - ì‹¤ì œ í‘¸ì‹œ ì•Œë¦¼ìš©
- **ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§**: í•˜ë“œì½”ë”© ë°ì´í„°

### ğŸŒ **í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œ í•„ìš”**
- **Admin ì›¹ UI**: ë°±ì—”ë“œ API ì™„ë£Œ, í”„ë¡ íŠ¸ì—”ë“œ ë¯¸ê°œë°œ
- **AI ìƒë‹´ ë‚´ì—­ ì¡°íšŒ**: PM í•µì‹¬ ìš”êµ¬ì‚¬í•­

## í–¥í›„ ë¡œë“œë§µ

### 1-3ê°œì›” ì¤‘ìš” ì‘ì—…
- **ASMR ê°œì¸í™” ì¶”ì²œ ì—”ì§„** - ì‚¬ìš©ìë³„ ë§ì¶¤ ì½˜í…ì¸  ì œê³µ
- **ìˆ˜ë©´ ì¼ì§€ ì‘ì„± UI** - ì£¼ê´€ì  í‰ê°€ ë°ì´í„° ìˆ˜ì§‘
- **í†µí•© ìˆ˜ë©´ ì§€ìˆ˜ ê°œë°œ** - ì •ëŸ‰ì  + ì£¼ê´€ì  ë°ì´í„° ìœµí•©
- **ASMR í’ˆì§ˆ ê³ ë„í™”** - ë¬´ì†ì‹¤ ì˜¤ë””ì˜¤, 3D ìŒí–¥ ì§€ì›

### 3-6ê°œì›” ì¥ê¸° ê³„íš
- **ê°œì¸ë³„ ìˆ˜ë©´ ë§Œì¡±ë„ ì˜ˆì¸¡ ëª¨ë¸** - ë¨¸ì‹ ëŸ¬ë‹ ê¸°ë°˜ ê°œì¸í™”
- **ë°”ì´ë…¸ëŸ´ ë¹„íŠ¸ í†µí•©** - ASMRê³¼ ë‡ŒíŒŒ ì¡°ì ˆ ìœµí•©
- **ì›¨ì–´ëŸ¬ë¸” ë””ë°”ì´ìŠ¤ ì—°ë™** - ì‹¤ì‹œê°„ ìƒì²´ ì‹ í˜¸ ë°˜ì˜
- **ìƒê´€ê´€ê³„ ë¶„ì„ ì‹œìŠ¤í…œ** - ì£¼ê´€ì /ê°ê´€ì  ë°ì´í„° íŒ¨í„´ ë°œê²¬

---

## ğŸ¤– AI/ML ê³ ë„í™” (RAG + í”„ë¡¬í”„íŠ¸ ì—”ì§€ë‹ˆì–´ë§)

### 1) RAG íŒŒì´í”„ë¼ì¸

- **ìƒ‰ì¸**: PDF/TXT â†’ í…ìŠ¤íŠ¸ ì¶”ì¶œ â†’ ì˜ë¯¸ ì²­í¬(200â€“400ì) â†’ ë‹¤êµ­ì–´ ì„ë² ë”© â†’ Qdrant ì—…ì„œíŠ¸  
- **ìŠ¤í‚¤ë§ˆ**: `vector + payload{ doc_id, title, language, format, page, section, url, text }`  
- **ê²€ìƒ‰**: ì§ˆì˜ ì„ë² ë”© â†’ Qdrant topâ€‘k(4â€“6) + ìŠ¤ì½”ì–´ ì„ê³„(cosine â‰¥ 0.78) â†’ (ì„ íƒ) MMR ì¬ë°°ì¹˜ â†’ ì»¨í…ìŠ¤íŠ¸ ì¡°ë¦½  
- **ìƒì„±**: â€œì»¨í…ìŠ¤íŠ¸ ê·¼ê±°ë§Œ ì‚¬ìš©, í•œêµ­ì–´ë¡œ ë‹µë³€, ëª¨ë¥´ë©´ ëª¨ë¥¸ë‹¤â€ ê·œì¹™ í”„ë¡¬í”„íŠ¸ë¡œ ì‘ë‹µ

#### í•µì‹¬ íŒŒë¼ë¯¸í„°
| í•­ëª©       | ê°’                   |
|-----------|----------------------|
| ì²­í¬ ê¸¸ì´   | 200â€“400ì            |
| topâ€‘k      | 4â€“6                 |
| ì„ê³„ì¹˜      | cosine â‰¥ 0.78      |
| ì–¸ì–´        | ko/en (ë‹µë³€ ko ê¸°ë³¸) |

#### Qdrant ê²€ìƒ‰ ì˜ˆì‹œ
```json
POST /collections/sleep_cbt/points/search
{
  "vector": [/* query embedding */],
  "top": 6,
  "with_payload": true,
  "score_threshold": 0.78,
  "params": { "hnsw_ef": 128 }
}
```

### 2) í”„ë¡¬í”„íŠ¸ ì—”ì§€ë‹ˆì–´ë§(ê°€ë“œë ˆì¼)

- **ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ìš”ì§€**  
  1. í•œêµ­ì–´ë¡œ ê°„ê²°íˆ, ì œê³µ ì»¨í…ìŠ¤íŠ¸ ë‚´ ê·¼ê±°ë§Œ ì‚¬ìš©  
  2. ê·¼ê±° ë¶€ì¡±/ë²”ìœ„ ë°–ì´ë©´ â€œëª¨ë¥¸ë‹¤â€ ë‹µë³€ í›„ ì „ë¬¸ì˜ ìƒë‹´ ê¶Œê³   
  3. ì¶œë ¥: ìš”ì§€ â†’ ê·¼ê±°(ì œëª©Â·ì—°ë„Â·í˜ì´ì§€) â†’ ì£¼ì˜/í–‰ë™ ê°€ì´ë“œ

```text
[System]
ë‹¹ì‹ ì€ CBT-I ê¸°ë°˜ ë¶ˆë©´ì¦ ìƒë‹´ ë„ìš°ë¯¸ì…ë‹ˆë‹¤.
- ì œê³µëœ ì»¨í…ìŠ¤íŠ¸ ë‚´ ì •ë³´ë§Œ ì‚¬ìš©í•˜ì„¸ìš”.
- ê·¼ê±°ê°€ ë¶€ì¡±í•˜ë©´ "ì œê³µëœ ìë£Œë¡œëŠ” í™•ë‹µí•˜ê¸° ì–´ë µìŠµë‹ˆë‹¤"ë¼ê³  ë‹µí•˜ê³ , ìœ„í—˜Â·ì•½ë¬¼ì€ ì „ë¬¸ì˜ ìƒë‹´ì„ ê¶Œê³ í•˜ì„¸ìš”.
- í•œêµ­ì–´ë¡œ ê°„ê²°íˆ, ë¦¬ìŠ¤íŠ¸ ìœ„ì£¼ë¡œ ë‹µí•˜ì„¸ìš”.
- ì¶œë ¥: â‘ ìš”ì§€ â‘¡ê·¼ê±°(ì œëª©Â·ì—°ë„Â·í˜ì´ì§€/ì„¹ì…˜) â‘¢ì£¼ì˜/í–‰ë™ ê°€ì´ë“œ
```

### 3) í‰ê°€/íŠœë‹

- **ê³¨ë“ ì…‹ 30ë¬¸í•­**: CBTâ€‘I íš¨ê³¼, ì ìš©, ê¸ˆê¸°, ìˆ˜ë©´ ìœ„ìƒ, ê°±ë…„ê¸° ì´ìŠˆ ë“±  
- **ì§€í‘œ**: Recall@k, Faithfulness(ê·¼ê±° ì¼ì¹˜), Relevance, p95 Latency, ì§ˆë¬¸ë‹¹ ë¹„ìš©  
- **ë°©ë²•**: ì˜¤í”„ë¼ì¸ í”„ë¡¬í”„íŠ¸ A/B â†’ ì£¼ 2íšŒ ë¦¬ê·¸ë ˆì…˜ìœ¼ë¡œ ì„±ëŠ¥ ì¶”ì  ë° íŒŒë¼ë¯¸í„° ì¡°ì •

### 4) í’ˆì§ˆÂ·ì•ˆì „ ê°€ë“œ

- í™˜ê° ì–µì œ: ìŠ¤ì½”ì–´ ì„ê³„ + ê·¼ê±° ì—†ìŒ ì‹œ ê±°ì ˆ í…œí”Œë¦¿  
- ì˜ë£Œ ì•ˆì „: ìœ„í—˜/ì•½ë¬¼ ì§ˆë¬¸ì—ëŠ” ì „ë¬¸ì˜ ìƒë‹´ ê¶Œê³  ë¬¸êµ¬ ì‚½ì…  
- ë°ì´í„° ìœ„ìƒ: í‘œ/ìˆ˜ì¹˜ëŠ” ìì—°ì–´ ì‚¬ì‹¤ ë¬¸ì¥ìœ¼ë¡œ ë³€í™˜ í›„ ì„ë² ë”©

### 5) ì„±ëŠ¥/ë¹„ìš© ìµœì í™”

- ê²½ëŸ‰ LLM ìš°ì„  ì‚¬ìš©, ë³µì¡í•œ ì§ˆì˜ë§Œ ìƒìœ„ ëª¨ë¸  
- ì»¨í…ìŠ¤íŠ¸ ì••ì¶•: ë¬¸ì„œ ìš”ì§€ 1â€“2ì¤„ ìƒì„± í›„ ëŒ€ì²´  
- ì§ˆë¬¸ ìœ ì‚¬ë„ ìºì‹±: ìœ ì‚¬ ì§ˆë¬¸ì— ëŒ€í•´ ì»¨í…ìŠ¤íŠ¸/ë‹µë³€ ì¬ì‚¬ìš©

### 6) Spring AI ì—°ë™(ê°„ë‹¨ ì˜ˆì‹œ)
```java
ChatClient client = ChatClient.builder(openAiChatModel)
  .defaultSystem(systemPrompt) // ìœ„ ê·œì¹™ ì ìš©
  .build();

var ctx = qdrant.search(embed(question), 6, 0.78);
String answer = client.prompt(formatCtx(ctx) + "\n\nQ: " + question);
```

### 7) ìì²´ ML ëª¨ë¸ ê°œë°œ
- TensorFlow/PyTorch ê¸°ë°˜ì˜ ìˆ˜ë©´ íŒ¨í„´ ë¶„ì„ ëª¨ë¸ ì—°êµ¬  
- Apache Flinkë¥¼ í™œìš©í•œ ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¼ ì²˜ë¦¬ ë° ì´ìƒ íŒ¨í„´ íƒì§€  
- ì¥ê¸°ì ì¸ ì˜ˆì¸¡ ë¶„ì„ ì‹œìŠ¤í…œ êµ¬í˜„ìœ¼ë¡œ ìˆ˜ë©´ ë¬¸ì œ ì¡°ê¸° ì˜ˆë°©

### 8) ê°œì¸í™” ì—”ì§„
- í˜‘ì—… í•„í„°ë§ ê¸°ë°˜ ì¶”ì²œ ì‹œìŠ¤í…œìœ¼ë¡œ ì‚¬ìš©ì ë§ì¶¤í˜• ì¡°ì–¸ ì œê³µ  
- ê°•í™”í•™ìŠµì„ í†µí•œ ê°œì¸í™” ëª¨ë¸ í•™ìŠµìœ¼ë¡œ ì§€ì†ì ì¸ ê°œì„   
- A/B í…ŒìŠ¤íŠ¸ í”Œë«í¼ êµ¬ì¶•ì„ í†µí•´ ì‹¤í—˜ì  ê¸°ëŠ¥ì„ ì•ˆì „í•˜ê²Œ ê²€ì¦

### 9) ì˜ˆìƒì¼ì • (RAG+í”„ë¡¬í”„íŠ¸ ì—”ì§€ë‹ˆì–´ë§)
- **~ 2025â€‘09â€‘23**: Spring + Qdrant E2E ë™ì‘(ì§ˆë¬¸â†’ê²€ìƒ‰â†’ë‹µë³€), íŒŒì´í”„ë¼ì¸ 1ì°¨ ì™„ì„±  
- **2025â€‘09â€‘23 ~ 10â€‘01**: í•œêµ­ì–´ ì „ìˆ˜ + ì˜ë¬¸ í•µì‹¬ ë…¼ë¬¸ ë°˜ì˜, topâ€‘k/ì„ê³„/í¬ë§· íŠœë‹  
- **2025â€‘10-01~ 10â€‘31**: ê¸°ë³¸ RAG AI ì‘ì—…ì„ ì •ë¦¬Â·ë§ˆë¬´ë¦¬í•˜ê³  ê²°ê³¼ ë¦¬ë·° (ì¶œì²˜ í‘œê¸°, UI, í´ë¼ìš°ë“œ ë°°í¬, ë°±ì—… ë“± ë¶€ê°€ ì‘ì—…ì€ ì œì™¸)  
- *(ì˜ˆì¸¡ ë¶„ì„ ì‹œìŠ¤í…œ ë° ê°œì¸í™” ì—”ì§„ ê°œë°œì€ ì¶”ê°€ ì‘ì—…ìœ¼ë¡œ ë³„ë„ ì¼ì •ì—ì„œ ì§„í–‰)*

## Spring AI (sleepBE)

- **í”„ë¡œì íŠ¸ ì„¤ì •**: Spring Boot ê¸°ë°˜ìœ¼ë¡œ ìƒˆ ë°±ì—”ë“œ ì„œë¹„ìŠ¤ë¥¼ êµ¬ì¶•, Spring AIì™€ Qdrant í´ë¼ì´ì–¸íŠ¸ ë„ì….  
- **AI ë¡œì§ ì´ì‹**: Python RAG ë¡œì§ì„ Javaë¡œ ì¬êµ¬í˜„í•˜ì—¬ ì„ë² ë”©, ê²€ìƒ‰, ìƒì„± ê¸°ëŠ¥ì„ Spring ì„œë¹„ìŠ¤ë¡œ í†µí•©.  
- **API êµ¬í˜„**: `/api/chat` ì—”ë“œí¬ì¸íŠ¸ë¥¼ ë§Œë“¤ì–´ ì§ˆë¬¸ì„ ë°›ì•„ ì„ë² ë”©â†’Qdrant ê²€ìƒ‰â†’LLM ì‘ë‹µì„ ë°˜í™˜í•˜ë„ë¡ ì„¤ê³„.  
- **DB ì „í™˜ ì¤€ë¹„**: Qdrantì— ë§ê²Œ ìŠ¤í‚¤ë§ˆ ì •ì˜ ë° ì—…ì„œíŠ¸ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±. PineconeëŠ” ë°±ì—… ìš©ë„ë¡œ ìœ ì§€.


---


# ğŸ™ ê°ì‚¬í•©ë‹ˆë‹¤

## Q&A ì‹œê°„

**ê¸°ìˆ  êµ¬í˜„ì— ëŒ€í•œ ì¶”ê°€ ì •ë¦¬:**

#### 1. ìˆ˜ë©´ í’ˆì§ˆ ì ìˆ˜ëŠ” ì–´ë–»ê²Œ ê³„ì‚°í•˜ë‚˜ìš”?
**ê¸°ìˆ ì  êµ¬í˜„:** `SleepQualityScoreService.java`
```java
// ì—°êµ¬ ê¸°ë°˜ ê°€ì¤‘ì¹˜ ì•Œê³ ë¦¬ì¦˜
private static final double DEEP_SLEEP_WEIGHT = 0.25;      // ê¹Šì€ ìˆ˜ë©´ - ì‹ ì²´ íšŒë³µ
private static final double REM_SLEEP_WEIGHT = 0.20;       // REM ìˆ˜ë©´ - ê¸°ì–µ í†µí•©
private static final double SLEEP_EFFICIENCY_WEIGHT = 0.20; // ìˆ˜ë©´ íš¨ìœ¨ì„± - ìˆ˜ë©´ ì—°ì†ì„±
private static final double WAKEUP_FREQUENCY_WEIGHT = 0.15; // ê°ì„± ë¹ˆë„ - ìˆ˜ë©´ ì§ˆ ì €í•˜
private static final double TOTAL_SLEEP_TIME_WEIGHT = 0.10; // ì´ ìˆ˜ë©´ì‹œê°„
private static final double ENVIRONMENTAL_WEIGHT = 0.10;    // í™˜ê²½ ìš”ì¸

// ì‹¤ì œ ê³„ì‚° ì˜ˆì‹œ
public double calculateSleepQualityScore(SleepRecord record) {
    double score = 0.0;

    // 1. ê¹Šì€ ìˆ˜ë©´ ì ìˆ˜ (ì´ìƒì : 15-20%)
    double deepSleepRatio = record.calculateDeepSleepRatio();
    if (deepSleepRatio >= 15 && deepSleepRatio <= 20) {
        score += DEEP_SLEEP_WEIGHT * 100;
    } else {
        score += DEEP_SLEEP_WEIGHT * Math.max(0, 100 - Math.abs(deepSleepRatio - 17.5) * 4);
    }

    // 2. REM ìˆ˜ë©´ ì ìˆ˜ (ì´ìƒì : 20-25%)
    double remSleepRatio = record.calculateRemSleepRatio();
    if (remSleepRatio >= 20 && remSleepRatio <= 25) {
        score += REM_SLEEP_WEIGHT * 100;
    } else {
        score += REM_SLEEP_WEIGHT * Math.max(0, 100 - Math.abs(remSleepRatio - 22.5) * 3);
    }

    // 3. ìˆ˜ë©´ íš¨ìœ¨ì„± (ì¹¨ëŒ€ì—ì„œ ì‹¤ì œ ì ë“  ì‹œê°„ ë¹„ìœ¨)
    double sleepEfficiency = record.calculateSleepEfficiency();
    score += SLEEP_EFFICIENCY_WEIGHT * sleepEfficiency;

    return Math.min(100, Math.max(0, score));
}
```

#### 2. ì „ë¬¸ì  ìˆ˜ë©´ ìƒë‹´ì„ ì–´ë–»ê²Œ ì œê³µí•˜ë‚˜ìš”?
**ê¸°ìˆ ì  êµ¬í˜„:** `AISleepAnalysisService.java`ì˜ ìƒë‹´ ì‹œìŠ¤í…œ
```java
// ì˜ë£Œì§„ ìˆ˜ì¤€ì˜ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
private String buildConsultationPrompt(String userMessage, Object sessionContext) {
    return """
    ë‹¹ì‹ ì€ ìˆ˜ë©´ì˜í•™ê³¼ ì „ë¬¸ì˜ ìˆ˜ì¤€ì˜ ì§€ì‹ì„ ê°€ì§„ AI ìƒë‹´ì‚¬ì…ë‹ˆë‹¤.

    ### ì „ë¬¸ ì§€ì‹ ê¸°ë°˜:
    - ìˆ˜ë©´ ìƒë¦¬í•™ ë° ìˆ˜ë©´ ë‹¨ê³„ë³„ íŠ¹ì„±
    - ìˆ˜ë©´ ì¥ì•  ì§„ë‹¨ ê¸°ì¤€ (DSM-5, ICSD-3)
    - ì¸ì§€í–‰ë™ì¹˜ë£Œ(CBT-I) ê¸°ë²•
    - ìˆ˜ë©´ ìœ„ìƒ ë° í™˜ê²½ ìµœì í™”
    - ê°œì¸ë³„ ìƒì²´ë¦¬ë“¬ íŒ¨í„´ ë¶„ì„

    ### ìƒë‹´ ì»¨í…ìŠ¤íŠ¸:
    - ì‚¬ìš©ì ìˆ˜ë©´ ê¸°ë¡: [ìµœê·¼ 7ì¼ ë°ì´í„° ìë™ í¬í•¨]
    - ìˆ˜ë©´ í’ˆì§ˆ ì ìˆ˜: [ê°œì¸ë³„ ì ìˆ˜ íˆìŠ¤í† ë¦¬]
    - í™˜ê²½ ìš”ì¸: [ì˜¨ë„, ìŠµë„, ì†ŒìŒ, ì¡°ë„ ë°ì´í„°]
    - ìƒí™œ íŒ¨í„´: [ì·¨ì¹¨/ê¸°ìƒ ì‹œê°„ ì¼ê´€ì„±]

    ì‚¬ìš©ì ë©”ì‹œì§€: "%s"

    ì „ë¬¸ì ì´ë©´ì„œë„ ì´í•´í•˜ê¸° ì‰¬ìš´ ë§ì¶¤í˜• ìƒë‹´ì„ ì œê³µí•´ì£¼ì„¸ìš”.
    """;
}
```

#### 3. ìŠ¤ë§ˆíŠ¸ íƒ€ì´ë° í•™ìŠµì€ ì–´ë–»ê²Œ í•˜ë‚˜ìš”?
**ê¸°ìˆ ì  êµ¬í˜„:** `PersonalizedTimingCalculatorImpl.java`
```java
// í†µê³„ì  ì•Œê³ ë¦¬ì¦˜ ê¸°ë°˜ íŒ¨í„´ í•™ìŠµ
public Optional<LocalTime> calculateOptimalSleepReminderTime(UserSleepSetting setting, boolean isWeekend) {
    // 1. ìµœê·¼ 30ì¼ ìˆ˜ë©´ ê¸°ë¡ì—ì„œ íŒ¨í„´ ì¶”ì¶œ
    List<SleepRecord> recentRecords = getRecentSleepRecords(setting.getUser().getId(), isWeekend);

    // 2. í‰ì¼/ì£¼ë§ ë¶„ë¦¬ ë¶„ì„
    OptionalDouble averageBedtime = recentRecords.stream()
        .filter(record -> record.getSleepStartTime() != null)
        .mapToDouble(record -> timeToMinutes(record.getSleepStartTime().toLocalTime()))
        .average();

    // 3. ì‚¬ìš©ì ë°˜ì‘ë¥  ê¸°ë°˜ íš¨ê³¼ì„± ì¸¡ì •
    double responseRate = calculateNotificationResponseRate(userId);

    // 4. ìˆ˜ë©´ í’ˆì§ˆê³¼ì˜ ìƒê´€ê´€ê³„ ë¶„ì„
    int recommendedMinutes;
    double quality = calculateAverageQuality(recentRecords);
    if (quality >= 80) {
        recommendedMinutes = 30;  // ìˆ˜ë©´ì˜ ì§ˆì´ ì¢‹ìœ¼ë©´ ì§§ì€ ì¤€ë¹„ ì‹œê°„
    } else if (quality >= 60) {
        recommendedMinutes = 60;  // ë³´í†µ
    } else {
        recommendedMinutes = 90;  // ìˆ˜ë©´ì˜ ì§ˆì´ ë‚˜ì˜ë©´ ê¸´ ì¤€ë¹„ ì‹œê°„
    }

    // 5. ìŠ¤ë§ˆíŠ¸í° ë¹„í™œì„± ì‹œê°„ ê³ ë ¤í•œ ìµœì í™”
    return adjustForPhoneInactiveTime(setting, calculatedTime);
}
```

#### 4. ê³ ë„í™”ëœ ASMR ìŠ¤íŠ¸ë¦¬ë°ì´ ë­”ê°€ìš”? WebFlux ë°˜ì‘í˜• ìŠ¤íŠ¸ë¦¬ë°ì´ ë­”ê°€ìš”?
**ê¸°ìˆ ì  êµ¬í˜„:** `ASMRStreamingService.java`ì—ì„œ WebFlux ë°˜ì‘í˜• í”„ë¡œê·¸ë˜ë° í™œìš©

**ğŸ” WebFlux ë°˜ì‘í˜•(Reactive) í”„ë¡œê·¸ë˜ë°ì´ë€?**
- **ë¹„ë™ê¸° ë…¼ë¸”ë¡œí‚¹** ë°©ì‹ìœ¼ë¡œ ë™ì‹œì— ë§ì€ ìš”ì²­ ì²˜ë¦¬ ê°€ëŠ¥
- **Mono<T>**: 0-1ê°œ ê²°ê³¼ë¥¼ ë¹„ë™ê¸°ë¡œ ë°˜í™˜í•˜ëŠ” ë°˜ì‘í˜• íƒ€ì…
- **ë°±í”„ë ˆì…”(Backpressure)**: ì²˜ë¦¬ ì†ë„ ì°¨ì´ë¥¼ ì¡°ì ˆí•˜ì—¬ ë©”ëª¨ë¦¬ ì˜¤ë²„í”Œë¡œìš° ë°©ì§€
- **í•¨ìˆ˜í˜• ì²´ì´ë‹**: `.doOnSuccess()`, `.doFinally()` ë“±ìœ¼ë¡œ íŒŒì´í”„ë¼ì¸ êµ¬ì„±

```java
// WebFlux Reactive Programmingìœ¼ë¡œ ë¹„ë™ê¸° ìŠ¤íŠ¸ë¦¬ë°
@Cacheable(value = "asmr-streaming", key = "#contentId + '_' + #quality")
public Mono<StreamingResponse> getStreamingResource(Long contentId, String quality, String rangeHeader) {
    return Mono.fromCallable(() -> {
        // ì ì‘í˜• í’ˆì§ˆ ì„ íƒ
        ASMRContentResponseDto content = asmrService.getContent(contentId);
        String audioUrl = getAudioUrlByQuality(content, quality);

        Resource resource = new UrlResource(audioUrl);

        // HTTP Range ìš”ì²­ ì§€ì› (ë¶€ë¶„ ìŠ¤íŠ¸ë¦¬ë°)
        if (rangeHeader != null && rangeHeader.startsWith("bytes=")) {
            return handleRangeRequest(resource, rangeHeader);
        }

        return StreamingResponse.builder()
                .resource(resource)
                .contentLength(resource.contentLength())
                .partialContent(false)
                .build();
    })
    // ë¹„ë™ê¸° ì²˜ë¦¬ ë©”íŠ¸ë¦­
    .doOnSuccess(response -> {
        activeStreams.incrementAndGet();
        qualityUsage.merge(quality, 1, Integer::sum);
        metricsService.recordStreamingStart(contentId, quality);
    })
    .doFinally(signalType -> {
        activeStreams.decrementAndGet();
        metricsService.recordStreamingEnd(contentId, quality, streamingDuration);
    });
}

// ì ì‘í˜• í’ˆì§ˆ ì¶”ì²œ ì•Œê³ ë¦¬ì¦˜
public Mono<QualityRecommendation> recommendQuality(Integer bandwidth, String networkType, String batteryLevel) {
    return Mono.fromCallable(() -> {
        String quality;
        if (bandwidth >= 500) quality = "high";       // 320kbps
        else if (bandwidth >= 200) quality = "medium"; // 128kbps
        else quality = "low";                         // 64kbps

        // ë°°í„°ë¦¬ ì ˆì•½ ëª¨ë“œ ê³ ë ¤
        if ("low".equals(batteryLevel)) quality = "medium";

        return QualityRecommendation.builder()
                .quality(quality)
                .bitrate(QUALITY_BITRATES.get(quality))
                .reason(determineReason(bandwidth, networkType, batteryLevel))
                .build();
    });
}
```

#### 5. ìˆ˜ë©´ íŠ¸ë Œë“œ ë¶„ì„ ì‹œìŠ¤í…œê³¼ ë‹¤ì°¨ì› íŒ¨í„´ ë¶„ì„ì€ ì–´ë–»ê²Œ í•˜ë‚˜ìš”?
**ê¸°ìˆ ì  êµ¬í˜„:** `AISleepAnalysisService.java`ì˜ ì¢…í•© ë¶„ì„
```java
// ë‹¤ì°¨ì› ë°ì´í„° ì „ì²˜ë¦¬
private Map<String, Object> prepareSleepDataForAI(SleepRecord sleepRecord) {
    Map<String, Object> data = new HashMap<>();

    // 1ì°¨ì›: ê¸°ë³¸ ìˆ˜ë©´ ë©”íŠ¸ë¦­
    data.put("totalSleepMinutes", sleepRecord.getTotalSleepMinutes());
    data.put("deepSleepMinutes", sleepRecord.getDeepSleepMinutes());
    data.put("lightSleepMinutes", sleepRecord.getLightSleepMinutes());
    data.put("remSleepMinutes", sleepRecord.getRemSleepMinutes());

    // 2ì°¨ì›: ê³„ì‚°ëœ ë¹„ìœ¨ ë° íš¨ìœ¨ì„±
    data.put("sleepEfficiency", sleepRecord.calculateSleepEfficiency());
    data.put("deepSleepRatio", sleepRecord.calculateDeepSleepRatio());
    data.put("lightSleepRatio", sleepRecord.calculateLightSleepRatio());

    // 3ì°¨ì›: í™˜ê²½ ìš”ì¸
    data.put("temperature", sleepRecord.getTemperature());
    data.put("humidity", sleepRecord.getHumidity());
    data.put("noiseLevel", sleepRecord.getNoiseLevel());
    data.put("lightLevel", sleepRecord.getLightLevel());

    // 4ì°¨ì›: ìƒì²´ ë°ì´í„° (ì‹œê³„ì—´)
    data.put("heartRateData", sleepRecord.getHeartRateData());
    data.put("respiratoryRateData", sleepRecord.getRespiratoryRateData());

    return data;
}

// AI ëª¨ë¸ì„ í†µí•œ íŒ¨í„´ ë¶„ì„ (GPT-4o-mini ë˜ëŠ” Claude-3.5-sonnet)
private String buildSleepAnalysisPrompt(Map<String, Object> sleepData) {
    return """
    ë‹¤ì°¨ì› ìˆ˜ë©´ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ íŒ¨í„´ì„ ì‹ë³„í•´ì£¼ì„¸ìš”:

    ğŸ“Š ìˆ˜ë©´ ë‹¨ê³„ë³„ ë¶„ì„:
    - ê¹Šì€ ìˆ˜ë©´ íŒ¨í„´ ë° ì‹ ì²´ íšŒë³µ íš¨ìœ¨ì„±
    - REM ìˆ˜ë©´ê³¼ ê¸°ì–µ í†µí•©, ì •ì„œ ì¡°ì ˆ ìƒê´€ê´€ê³„
    - ì–•ì€ ìˆ˜ë©´ì˜ ê°ì„± ì¤€ë¹„ ìƒíƒœ í‰ê°€

    ğŸŒ¡ï¸ í™˜ê²½-ìˆ˜ë©´ì§ˆ ìƒê´€ê´€ê³„:
    - ì˜¨ë„/ìŠµë„ ìµœì í™” êµ¬ê°„ ì‹ë³„
    - ì†ŒìŒ/ì¡°ë„ê°€ ìˆ˜ë©´ ë‹¨ê³„ì— ë¯¸ì¹˜ëŠ” ì˜í–¥
    - ê°œì¸ë³„ í™˜ê²½ ë¯¼ê°ë„ í”„ë¡œíŒŒì¼ë§

    ğŸ’“ ìƒì²´ ë¦¬ë“¬ ë¶„ì„:
    - ì‹¬ë°•ìˆ˜ ë³€ë™ì„±ê³¼ ììœ¨ì‹ ê²½ê³„ ìƒíƒœ
    - í˜¸í¡ íŒ¨í„´ì˜ ìˆ˜ë©´ ë‹¨ê³„ë³„ ë³€í™”
    - ìƒì²´ ì‹ í˜¸ ê¸°ë°˜ ìˆ˜ë©´ ì¥ì•  ìœ„í—˜ë„ í‰ê°€

    ì´ë¥¼ í†µí•´ ì¢…í•©ì ì¸ ìˆ˜ë©´ ê°œì„  ì „ëµì„ ì œì‹œí•´ì£¼ì„¸ìš”.
    """;
}
```

**í•µì‹¬ ì°¨ë³„ì :** ë‹¨ìˆœí•œ LLM í™œìš©ì´ ì•„ë‹Œ, ì „ë¬¸ ì§€ì‹ì„ í”„ë¡¬í”„íŠ¸ ì—”ì§€ë‹ˆì–´ë§ìœ¼ë¡œ êµ¬í˜„í•˜ê³ , ê°œì¸ë³„ ìˆ˜ë©´ ë°ì´í„° íˆìŠ¤í† ë¦¬ë¥¼ ì»¨í…ìŠ¤íŠ¸ë¡œ í™œìš©í•˜ëŠ” ê°œì¸í™”ëœ AI ìƒë‹´ ì‹œìŠ¤í…œ

---
